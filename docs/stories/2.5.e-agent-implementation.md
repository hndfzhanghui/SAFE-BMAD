# Story 2.5: E-Agent (执行者) 实现

## Status
Draft

## Story

**As a** 系统用户,
**I want** E-Agent能够基于战略框架和专家分析制定详细的执行计划,
**so that** 获得可操作的应急响应执行方案和任务分配指导。

## Acceptance Criteria

1. E-Agent能够整合S-Agent战略框架和F-Agent专家分析
2. 基于资源约束制定详细执行计划
3. 实现任务分解和分配优化
4. 提供执行进度监控和调整机制
5. 输出结构化的执行指导文档

## Tasks / Subtasks

- [ ] 实现E-Agent核心功能 (AC: #1)
  - [ ] 创建EAgent类继承BaseAgent
    - [ ] 实现__init__初始化方法
    - [ ] 配置E-Agent特定参数
    - [ ] 设置执行引擎和调度器
    - [ ] 初始化资源管理器
  - [ ] 设计计划整合系统
    - [ ] 战略框架解析器
    - [ ] 专家分析整合器
    - [ ] 多源信息融合器
    - [ ] 计划一致性检查器
  - [ ] 实现执行引擎
    - [ ] 任务分解引擎
    - [ ] 依赖关系分析器
    - [ ] 并行任务调度器
    - [ ] 执行状态监控器
  - [ ] 创建资源管理模块
    - [ ] 资源需求评估器
    - [ ] 资源分配优化器
    - [ ] 资源冲突解决器
    - [ ] 资源使用监控器
  - [ ] 实现执行协调器
    - [ ] 任务分配协调器
    - [ ] 进度同步协调器
    - [ ] 异常处理协调器
    - [ ] 执行优化协调器

- [ ] 实现执行计划制定 (AC: #2)
  - [ ] 设计任务分解系统
    - [ ] 战略目标分解器
    - [ ] 专家建议转化器
    - [ ] 任务粒度优化器
    - [ ] 任务依赖分析器
  - [ ] 实现资源约束分析
    - [ ] 资源可用性评估器
    - [ ] 资源需求计算器
    - [ ] 约束条件建模器
    - [ ] 瓶颈识别器
  - [ ] 创建执行调度器
    - [ ] 时间调度算法
    - [ ] 资源调度算法
    - [ ] 优先级调度器
    - [ ] 动态调度调整器
  - [ ] 实现计划优化器
    - [ ] 多目标优化算法
    - [ ] 执行效率优化器
    - [ ] 成本效益优化器
    - [ ] 风险缓解优化器
  - [ ] 设计计划验证机制
    - [ ] 计划可行性验证
    - [ ] 逻辑一致性检查
    - [ ] 资源约束验证
    - [ ] 时间窗口验证

- [ ] 实现任务分配优化 (AC: #3)
  - [ ] 设计任务特征分析
    - [ ] 任务复杂度评估器
    - [ ] 技能需求分析器
    - [ ] 资源需求计算器
    - [ ] 执行时间估算器
  - [ ] 实现执行主体建模
    - [ ] 执行主体能力模型
    - [ ] 历史表现分析器
    - [ ] 可用性时间表
    - [ ] 负载均衡分析器
  - [ ] 创建分配算法
    - [ ] 最佳匹配算法
    - [ ] 负载均衡算法
    - [ ] 多目标分配算法
    - [ ] 动态重分配算法
  - [ ] 实现分配优化器
    - [ ] 分配效果评估器
    - [ ] 分配方案迭代优化
    - [ ] 冲突检测和解决
    - [ ] 分配结果验证器
  - [ ] 设计分配监控机制
    - [ ] 分配执行监控器
    - [ ] 异常检测器
    - [ ] 自动重分配器
    - [ ] 分配效果评估器

- [ ] 实现执行监控调整 (AC: #4)
  - [ ] 设计进度监控系统
    - [ ] 任务进度跟踪器
    - [ ] 里程碑监控器
    - [ ] 关键路径监控器
    - [ ] 整体进度评估器
  - [ ] 实现异常检测系统
    - [ ] 偏差检测器
    - [ ] 延迟检测器
    - [ ] 资源冲突检测器
    - [ ] 执行失败检测器
  - [ ] 创建调整机制
    - [ ] 动态计划调整器
    - [ ] 资源重新分配器
    - [ ] 优先级调整器
    - [ ] 应急响应调度器
  - [ ] 实现反馈系统
    - [ ] 执行反馈收集器
    - [ ] 效果评估分析器
    - [ ] 经验学习提取器
    - [ ] 计划改进建议器
  - [ ] 设计预警机制
    - [ ] 风险预警器
    - [ ] 延迟预警器
    - [ ] 资源预警器
    - [ ] 质量预警器

- [ ] 实现结构化执行指导 (AC: #5)
  - [ ] 设计执行数据模型
    - [ ] ExecutionPlan执行计划结构
    - [ ] Task任务结构
    - [ ] ResourceAssignment资源分配结构
    - [ ] ExecutionStatus执行状态结构
  - [ ] 实现JSON格式化输出
    - [ ] 执行计划JSON格式
    - [ ] 任务详情JSON格式
    - [ ] 资源分配JSON格式
    - [ ] 进度报告JSON格式
  - [ ] 创建多格式输出支持
    - [ ] JSON格式(主要)
    - [ ] 甘特图格式
    - [ ] 任务清单格式
    - [ ] 执行报告格式
  - [ ] 实现输出验证机制
    - [ ] 计划完整性验证
    - [ ] 任务逻辑验证
    - [ ] 资源分配验证
    - [ ] 输出格式规范检查
  - [ ] 创建执行可视化工具
    - [ ] 执行时间线可视化
    - [ ] 任务依赖关系图
    - [ ] 资源分配图表
    - [ ] 进度监控仪表板

## 开发技术指引

### 核心技术栈
- AI框架: AutoGen + DeepSeek V3 (执行规划能力)
- 优化算法: 约束优化 + 启发式算法 + 模拟退火
- 调度引擎: 自适应任务调度 + 并行执行优化
- 资源管理: 资源约束优化 + 冲突解决算法
- 监控系统: 实时进度监控 + 异常检测

### E-Agent核心接口
```python
# 基于AutoGen的E-Agent实现
class ExecutionPlanner(SAFERoleAgent):
    """执行规划者 - 基于AutoGen的E-Agent实现"""

    def __init__(self, agent_id: str, config: Dict[str, Any]):
        super().__init__(
            name="Execution_Planner",
            role_class=ExecutionPlanner,
            system_message=self._get_executor_prompt(),
            tools=[self.artifact_manager, self.optimizer, self.scheduler],
            capabilities=['execution_planning', 'task_scheduling', 'resource_optimization']
        )

        self.config = config
        self.max_planning_time = config.get('max_planning_time', 30.0)
        self.optimization_algorithms = self._load_optimization_algorithms()
        self.resource_constraints = self._initialize_resource_constraints()

    async def _process_task(self, task: Dict, context: Dict) -> str:
        """执行规划者的任务处理逻辑"""
        description = task['description']

        if '执行计划' in description or 'execution' in description:
            return await self._execution_planning(task, context)
        elif '任务调度' in description or 'scheduling' in description:
            return await self._task_scheduling(task, context)
        elif '资源优化' in description or 'optimization' in description:
            return await self._resource_optimization(task, context)
        else:
            return await super()._process_task(task, context)

    async def _execution_planning(self, task: Dict, context: Dict) -> str:
        """执行计划制定核心逻辑"""
        try:
            # 1. 从ArtifactManager获取战略框架和专家分析结果
            strategic_framework = await self.artifact_manager.load(
                identifier=f"analysis_results/{context.get('event_id')}/strategic_framework.json"
            )

            expert_analyses = await self._collect_expert_analyses(context)

            # 2. 整合战略目标和专业建议
            integrated_analysis = await self._integrate_analysis_results(
                strategic_framework, expert_analyses
            )

            # 3. 任务分解和依赖分析
            task_breakdown = await self._decompose_tasks(integrated_analysis)
            task_dependencies = await self._analyze_task_dependencies(task_breakdown)

            # 4. 资源需求评估和约束分析
            resource_requirements = await self._assess_resource_requirements(task_breakdown)
            resource_constraints = await self._analyze_resource_constraints(context)

            # 5. 执行计划优化
            optimized_plan = await self.optimizer.optimize_execution_plan(
                tasks=task_breakdown,
                dependencies=task_dependencies,
                resource_requirements=resource_requirements,
                constraints=resource_constraints
            )

            # 6. 风险评估和应急预案
            risk_assessment = await self._assess_execution_risks(optimized_plan)
            contingency_plans = await self._generate_contingency_plans(optimized_plan, risk_assessment)

            # 7. 生成执行指导文档
            execution_guide = await self._generate_execution_guide({
                'strategic_framework': strategic_framework,
                'expert_analyses': expert_analyses,
                'optimized_plan': optimized_plan,
                'risk_assessment': risk_assessment,
                'contingency_plans': contingency_plans,
                'resource_allocation': optimized_plan.get('resource_allocation'),
                'timeline': optimized_plan.get('timeline'),
                'milestones': optimized_plan.get('milestones')
            })

            # 8. 保存执行计划到ArtifactManager
            await self.artifact_manager.save(
                identifier=f"execution_plans/{context.get('event_id')}/execution_plan.json",
                content=execution_guide,
                content_type="json"
            )

            return f"执行计划制定完成: 包含{len(task_breakdown)}个任务, {len(resource_requirements)}种资源需求"

        except Exception as e:
            logger.error(f"执行计划制定失败: {str(e)}")
            return f"执行计划制定失败: {str(e)}"

    def _get_executor_prompt(self) -> str:
        return """
        你是SAFE应急决策系统的执行规划者(Execution Planner)。

        核心职责：
        1. 整合S-Agent战略框架和F-Agent专家分析
        2. 制定详细可操作的应急响应执行计划
        3. 优化任务调度和资源分配
        4. 监控执行进度并动态调整计划
        5. 生成风险预案和应急响应指导

        执行规划能力：
        - 战略目标的具体化分解
        - 任务依赖关系分析
        - 资源约束下的优化调度
        - 风险评估和应急预案制定
        - 实时进度监控和调整

        工作流程：
        1. 解析战略框架和收集专家分析结果
        2. 将战略目标分解为可执行的具体任务
        3. 分析任务依赖关系和资源需求
        4. 制定优化的执行计划和资源分配方案
        5. 识别执行风险并制定应急预案
        6. 生成详细的执行指导文档
        7. 通过ArtifactManager共享执行计划

        协作原则：
        - 确保执行计划与战略目标的一致性
        - 充分考虑专家建议的技术可行性
        - 在资源约束下实现最优调度
        - 实时监控执行状态并及时调整
        - 通过ArtifactManager与其他组件共享信息
        """

### 开发注意事项
- 基于AutoGen框架构建，充分发挥DeepSeek V3的执行规划能力
- 整合S-Agent战略框架和F-Agent专家分析结果
- 实现复杂的任务分解和依赖关系分析
- 在资源约束下进行优化调度和资源分配
- 支持实时执行监控和动态调整

### 性能要求
- 执行计划制定时间: ≤30秒(中等复杂度计划)
- 任务调度优化时间: ≤15秒
- 资源分配优化准确率: >90%
- 计划执行率: >85%

### 执行规划重点
- **任务分解**: 将战略目标分解为可执行的具体任务
- **依赖分析**: 分析任务间的依赖关系和执行顺序
- **资源优化**: 在约束条件下优化资源分配
- **风险评估**: 识别执行风险并制定应急预案
- **动态调整**: 实时监控执行状态并及时调整计划

### 调度策略
- **优先级调度**: 基于任务重要性和紧急程度
- **并行执行**: 识别可并行执行的任务提高效率
- **负载均衡**: 避免资源过度集中和瓶颈
- **时间约束**: 确保关键时间节点的任务完成
- **容错机制**: 处理任务失败和资源冲突

### 资源管理策略
- **需求评估**: 准确评估各任务的人力物力需求
- **约束分析**: 分析资源可用性和时间约束
- **分配优化**: 使用优化算法进行最优资源分配
- **冲突解决**: 处理资源竞争和调度冲突
- **效率监控**: 监控资源使用效率和执行进度

### 协作模式
- **计划整合**: 通过ArtifactManager整合各方输入
- **反馈收集**: 收集执行过程中的反馈和建议
- **动态调整**: 根据实际情况调整执行计划
- **状态同步**: 保持与各方执行状态的同步
- **结果验证**: 验证执行结果与计划的一致性

### 测试策略
- 单元测试: pytest + 调度算法验证
- 优化测试: 资源分配和任务调度优化验证
- 集成测试: 与S-Agent和F-Agent的协作测试
- 模拟测试: 执行计划的完整流程模拟

### 依赖关系
- 依赖Epic 1的基础框架和资源管理系统
- 基于AutoGen多智能体框架实现执行规划
- 依赖S-Agent的战略框架和F-Agent的专家分析
- 为应急响应提供详细的执行指导方案

## Change Log
