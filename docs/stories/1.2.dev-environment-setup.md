# Story 1.2: 基础开发环境配置

## Status
Draft

## Story

**As a** 开发工程师,
**I want** 拥有完整的本地开发环境,
**so that** 快速开始开发和调试功能。

## Acceptance Criteria

1. Docker开发环境配置完成，支持一键启动所有服务
2. PostgreSQL数据库配置，包含基础表结构设计
3. Redis缓存服务配置，支持基础缓存功能
4. 环境变量管理配置(.env文件)
5. 本地API服务启动，基础健康检查接口正常工作

## Tasks / Subtasks

- [ ] 配置Docker开发环境 (AC: #1)
  - [ ] 创建根目录docker-compose.yml文件
    - [ ] 定义Python后端服务(基于python:3.9-slim镜像)
    - [ ] 定义PostgreSQL数据库服务(postgres:14镜像)
    - [ ] 定义Redis缓存服务(redis:7-alpine镜像)
    - [ ] 定义前端服务(基于node:18-alpine镜像，可选)
    - [ ] 配置服务间网络连接和数据卷
  - [ ] 创建Docker开发配置文件
    - [ ] docker-compose.dev.yml - 开发环境专用配置
    - [ ] docker-compose.override.yml - 本地覆盖配置
    - [ ] .dockerignore文件 - 排除不需要的文件
  - [ ] 配置服务健康检查
    - [ ] 后端API健康检查(/health端点)
    - [ ] 数据库连接健康检查
    - [ ] Redis连接健康检查
  - [ ] 创建一键启动脚本
    - [ ] dev-start.sh - 启动开发环境
    - [ ] dev-stop.sh - 停止开发环境
    - [ ] dev-restart.sh - 重启开发环境

- [ ] 配置PostgreSQL数据库 (AC: #2)
  - [ ] 创建数据库初始化脚本
    - [ ] init-db.sql - 数据库和用户创建
    - [ ] create-tables.sql - 基础表结构创建
    - [ ] seed-data.sql - 初始数据插入
  - [ ] 配置数据库连接参数
    - [ ] 数据库主机、端口、用户名、密码
    - [ ] 连接池配置
    - [ ] SSL配置(开发环境可关闭)
  - [ ] 创建数据库迁移脚本
    - [ ] migrations/目录结构
    - [ ] 001_initial_schema.sql - 初始架构
    - [ ] 创建迁移管理脚本
  - [ ] 配置数据库备份和恢复
    - [ ] backup.sh - 数据库备份脚本
    - [ ] restore.sh - 数据库恢复脚本
    - [ ].dockerignore排除备份文件

- [ ] 配置Redis缓存服务 (AC: #3)
  - [ ] 创建Redis配置文件
    - [ ] redis.conf - Redis服务配置
    - [ ] 内存配置和持久化设置
    - [ ] 网络安全配置(开发环境宽松设置)
  - [ ] 配置Redis连接参数
    - [ ] 连接主机、端口、密码
    - [ ] 连接池配置
    - [ ] 超时和重试设置
  - [ ] 创建缓存管理工具
    - [ ] cache-cli.sh - Redis命令行工具
    - [ ] flush-cache.sh - 清空缓存脚本
    - [ ] monitor-cache.sh - 缓存监控脚本
  - [ ] 配置Redis数据结构
    - [ ] session存储配置
    - [ ] API响应缓存配置
    - [ ] 数据库查询缓存配置

- [ ] 配置环境变量管理 (AC: #4)
  - [ ] 创建环境变量模板文件
    - [ ] .env.template - 环境变量模板
    - [ ] .env.example - 示例配置
    - [ ] .env.local - 本地开发配置(不提交到Git)
  - [ ] 配置开发环境变量
    - [ ] 数据库连接参数
    - [ ] Redis连接参数
    - [ ] API服务配置(端口、调试模式等)
    - [ ] 日志级别配置
    - [ ] 第三方服务配置(如需要)
  - [ ] 配置生产环境变量模板
    - [ ] .env.production.template - 生产环境模板
    - [ ] .env.staging.template - 测试环境模板
  - [ ] 创建环境变量验证脚本
    - [ ] validate-env.sh - 验证必需的环境变量
    - [ ] generate-env.sh - 生成环境配置文件
  - [ ] 配置环境变量文档
    - [ ] docs/environment-variables.md - 环境变量说明
    - [ ] 各环境配置差异说明

- [ ] 启动和测试本地API服务 (AC: #5)
  - [ ] 创建API服务启动脚本
    - [ ] start-api.sh - 启动API服务
    - [ ] start-dev.sh - 开发模式启动(热重载)
    - [ ] stop-api.sh - 停止API服务
  - [ ] 实现基础健康检查接口
    - [ ] GET /health - 基础健康检查
    - [ ] GET /ready - 就绪状态检查
    - [ ] GET /metrics - 基础指标(可选)
  - [ ] 创建API测试脚本
    - [ ] test-health.sh - 健康检查测试
    - [ ] test-connectivity.sh - 连接性测试
    - [ ] test-basic-api.sh - 基础API功能测试
  - [ ] 配置API文档访问
    - [ ] Swagger UI访问配置
    - [ ] ReDoc文档访问配置
    - [ ] API文档自动更新配置

## Dev Notes

### 技术架构信息
本地开发环境基于Docker容器化技术，确保开发环境的一致性和可移植性：
- 数据库: PostgreSQL 14 (容器化部署)
- 缓存: Redis 7 (容器化部署)
- 后端: Python 3.9+ FastAPI (开发模式支持热重载)
- 前端: React 18 (可选容器化开发)
- 容器编排: Docker Compose

### 开发环境配置
```yaml
# docker-compose.yml 主要服务配置
services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - RELOAD=true
    volumes:
      - .:/app
    depends_on:
      - db
      - redis

  db:
    image: postgres:14
    environment:
      - POSTGRES_DB=safe_dev
      - POSTGRES_USER=safe_user
      - POSTGRES_PASSWORD=safe_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
```

### 环境变量配置示例
```bash
# .env.template
# 数据库配置
DATABASE_URL=postgresql://safe_user:safe_password@localhost:5432/safe_dev
DB_HOST=localhost
DB_PORT=5432
DB_NAME=safe_dev
DB_USER=safe_user
DB_PASSWORD=safe_password

# Redis配置
REDIS_URL=redis://localhost:6379/0
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# API服务配置
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=true
LOG_LEVEL=INFO

# 安全配置
SECRET_KEY=your-secret-key-here
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### 数据库基础表结构
```sql
-- 基础用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 基础场景表
CREATE TABLE scenarios (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    type VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Agent状态表
CREATE TABLE agent_status (
    id SERIAL PRIMARY KEY,
    agent_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB
);
```

### 开发工作流
1. 克隆项目仓库
2. 复制 `.env.template` 到 `.env.local` 并配置参数
3. 运行 `./scripts/dev-start.sh` 启动开发环境
4. 等待所有服务启动完成(约30-60秒)
5. 访问 http://localhost:8000/health 验证API服务
6. 访问 http://localhost:8000/docs 查看API文档

### 依赖关系说明
- 依赖Story 1.1完成的项目结构
- 为Story 1.3数据库设计提供基础环境
- 为后续API开发提供完整的开发和测试环境

### 重要注意事项
- 确保Docker和Docker Compose已正确安装
- 开发环境端口8000、5432、6379需要未被占用
- 首次启动需要等待数据库初始化完成
- .env.local文件包含敏感信息，不要提交到Git
- 开发环境的数据不会持久化，重启会丢失

### 故障排除指南
- **端口冲突**: 修改docker-compose.yml中的端口映射
- **数据库连接失败**: 检查.env文件中的数据库配置
- **Redis连接失败**: 确认Redis服务正常启动
- **API服务启动失败**: 检查Python依赖安装情况
- **权限问题**: 确保脚本文件有执行权限

### Testing

#### 测试标准
- 测试文件位置: tests/目录下按类型分类
- 环境测试: tests/environment/ - 开发环境配置测试
- 集成测试: tests/integration/ - 服务间集成测试
- 健康检查测试: tests/health/ - 服务健康状态测试

#### 测试框架和模式
- 环境测试: 使用shell脚本验证Docker服务状态
- API测试: pytest + httpx - 测试API接口功能
- 数据库测试: pytest + psycopg2 - 测试数据库连接和基础操作
- Redis测试: pytest + redis-py - 测试缓存功能

#### 特定测试要求
- Docker容器启动测试: 验证所有服务正常启动
- 数据库连接测试: 验证数据库连接和基础操作
- API健康检查测试: 验证健康检查接口响应
- 环境变量测试: 验证必需环境变量配置正确
- 服务依赖测试: 验证服务间依赖关系正常

#### 测试脚本示例
```bash
#!/bin/bash
# tests/environment/test-docker-startup.sh
# 测试Docker服务启动

echo "测试Docker服务启动..."

# 检查API服务
curl -f http://localhost:8000/health || {
    echo "❌ API服务启动失败"
    exit 1
}

# 检查数据库连接
docker exec safe_db_1 pg_isready -U safe_user -d safe_dev || {
    echo "❌ 数据库连接失败"
    exit 1
}

# 检查Redis连接
docker exec safe_redis_1 redis-cli ping || {
    echo "❌ Redis连接失败"
    exit 1
}

echo "✅ 所有服务启动正常"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)