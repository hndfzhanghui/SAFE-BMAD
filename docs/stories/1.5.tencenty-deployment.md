# Story 1.5: 腾讯云部署环境准备

## Status
Draft

## Story

**As a** DevOps工程师,
**I want** 拥有腾讯云测试环境,
**so that** 部署和测试应用。

## Acceptance Criteria

1. 腾讯云CVM服务器配置和安全组设置
2. 云数据库PostgreSQL实例创建和配置
3. 云Redis实例创建和配置
4. 对象存储COS配置，用于文件存储
5. 基础CI/CD流水线配置(可选)

## Tasks / Subtasks

- [ ] 配置腾讯云CVM服务器 (AC: #1)
  - [ ] 创建CVM实例
    - [   选择合适的实例规格(2核4G起步)
    - [   选择合适的操作系统镜像(Ubuntu 20.04 LTS)
    - [   配置网络和安全组
    - [   设置SSH密钥认证
  - [ ] 配置安全组规则
    - [   开放HTTP(80)端口
    - [   开放HTTPS(443)端口
    - [   开放SSH(22)端口(仅内网)
    - [   配置数据库端口访问规则
  - [ ] 初始化服务器环境
    - [   更新系统包
    - [   安装Docker和Docker Compose
    - [   配置防火墙规则
    - [   设置用户权限管理
  - [ ] 配置网络连接
    - [   配置弹性公网IP
    - [   设置域名解析(可选)
    - [   配置负载均衡器(可选)
    - [   设置CDN加速(可选)
  - [ ] 创建服务器管理脚本
    - [   scripts/deploy.sh - 部署脚本
    - [   scripts/backup.sh - 备份脚本
    - [   scripts/monitor.sh - 监控脚本
    - [   scripts/update.sh - 更新脚本

- [ ] 创建和配置云数据库PostgreSQL (AC: #2)
  - [ ] 创建PostgreSQL实例
    - [   选择合适的实例规格
    - [   选择PostgreSQL版本(14+)
    - [   配置VPC网络
    - [   设置实例名称和描述
  - [ ] 配置数据库参数
    - [   设置字符集为UTF8
    - [   配置时区为UTC+8
    - [   配置连接池参数
    - [   设置备份策略
  - [ ] 配置数据库访问
    - [   创建数据库用户和权限
    - [   配置白名单访问规则
    - [   设置SSL连接加密
    - [   配置读写分离(可选)
  - [ ] 设置数据库备份
    - [   配置自动备份策略
    - [   设置备份保留周期
    - [   配置备份存储位置
    - [   测试备份恢复功能
  - [   创建数据库管理工具
    - [   配置数据库连接管理
    - [   创建数据库迁移脚本
    - [   设置性能监控配置
    - [   配置日志管理

- [ ] 创建和配置云Redis实例 (AC: #3)
  - [ ] 创建Redis实例
    - [   选择合适的实例规格
    - [   选择Redis版本(6+)
    - [   配置网络和安全组
    - [   设置实例类型(主从/集群)
  - [ ] 配置Redis参数
    - [   设置内存限制
    - [   配置持久化策略
    - [   设置连接数限制
    - [   配置过期策略
  - [ ] 配置Redis访问
    - [   设置访问密码认证
    - [   配置白名单访问规则
    - [   设置SSL连接加密
    - [   配置网络隔离
  - [ ] 设置Redis备份
    - [   配置自动备份策略
    - [   设置备份保留周期
    - [   测试备份恢复功能
    - [   配置备份加密
  - [ ] 创建Redis管理工具
    - [   配置连接池管理
    - [   创建监控配置
    - [   设置集群管理(如使用)
    - [   配置故障转移

- [ ] 配置对象存储COS (AC: #4)
  - [ ] 创建COS存储桶
    - [   选择合适的存储桶名称
    - [   设置访问权限为私有读写
    - [   配置地域和存储类型
    - [   设置生命周期管理
  - [ ] 配置COS访问权限
    - [   创建访问密钥
    - [   配置跨域访问规则
    - [   设置防盗链配置
    - [   配置CDN加速
  - [ ] 设置存储分类管理
    - [   配置标准存储
    - [   配置低频访问存储
    - [   配置归档存储
    - [   设置智能分层存储
  - [ ] 实现文件上传功能
    - [   配置SDK集成
    - [   实现文件上传API
    - [   配置文件下载功能
    - [   设置文件预览功能
  - [ ] 配置文件管理
    - [   设置文件版本控制
    - [   配置文件同步
    - [   设置文件备份策略
    - [   配置文件压缩

- [ ] 配置基础CI/CD流水线 (AC: #5)
  - [ ] 选择CI/CD平台
    - [   腾讯云CI/CD(推荐)
    - [   GitHub Actions(备选)
    - [   Jenkins(备选)
    - [   GitLab CI(备选)
  - [ ] 创建构建流水线
    - [   配置代码检出
    - [   设置构建环境
    - [   配置依赖安装
    - [   设置构建脚本
  - [ ] 创建测试流水线
    - [   配置单元测试
    - [   配置集成测试
    - [   配置API测试
    - [   设置测试报告
  - [ ] 创建部署流水线
    - [   配置部署环境
    - [   设置部署脚本
    - [   配置健康检查
    - [   设置回滚机制
  - [ ] 配置通知机制
    - [   构建成功/失败通知
    - [   部署成功/失败通知
    [   配置企业微信通知
    [   配置邮件通知

- [ ] 创建部署文档和脚本 (AC: #5)
  - [ ] 编写部署指南
    - [   docs/deployment/deployment-guide.md
    - [   环境配置说明
    - [   常见问题解决方案
    - [   故障排除指南
  - [ ] 创建环境配置文件
    - [   .env.production.template - 生产环境模板
    - [   .env.staging.template - 测试环境模板
    - [   docker-compose.prod.yml - 生产环境配置
    - [   nginx.conf - Web服务器配置
  - [ ] 创建运维脚本
    - [   scripts/deploy-prod.sh - 生产环境部署
    - [   scripts/rollback.sh - 回滚脚本
    - [   scripts/health-check.sh - 健康检查
    - [   scripts/log-collection.sh - 日志收集
  - [ ] 配置监控和告警
    - [   腾讯云监控配置
    [   自定义监控指标
    [   告警规则配置
    [   告警通知配置

## Dev Notes

### 技术架构信息
腾讯云部署环境采用云原生架构：
- 计算服务: 腾讯云CVM (2核4G起步)
- 数据库: 腾讯云PostgreSQL (高可用版)
- 缓存: 腾讯云Redis (主从版)
- 存储: 腾讯云COS (标准存储)
- 网络: 腾讯云VPC + 安全组
- CI/CD: 腾讯云CI/CD 或 GitHub Actions

### 腾讯云资源配置建议
```yaml
# CVM实例配置
CVM:
  实例规格: S5.MEDIUM2 (2核4G)
  操作系统: Ubuntu 20.04 LTS
  系统盘: 50GB SSD云硬盘
  数据盘: 100GB SSD云硬盘
  网络: 私有网络(VPC)
  公网IP: 弹性公网IP

# PostgreSQL配置
PostgreSQL:
  实例规格: 2核4G (PostgreSQL 14)
  存储空间: 100GB SSD
  备份策略: 每日自动备份
  高可用: 主从复制
  网络: 私有网络访问

# Redis配置
Redis:
  实例规格: 2G内存版
  架构: 主从版
  持久化: RDB + AOF
  备份策略: 每日自动备份
  网络: 私有网络访问

# COS存储配置
COS:
  存储桶: safe-system-storage
  地域: 北京地域
  存储类型: 标准存储
  权限: 私有读写
  生命周期: 30天自动删除临时文件
```

### Docker生产环境配置
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  api:
    image: safe-system:latest
    restart: unless-stopped
    ports:
      - "80:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api

  db:
    image: postgres:14
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### Nginx配置示例
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream api_backend {
        server api:8000;
    }

    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location / {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /health {
            proxy_pass http://api_backend/health;
            access_log off;
        }

        location /static/ {
            alias /app/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### 部署脚本示例
```bash
#!/bin/bash
# scripts/deploy-prod.sh

set -e

echo "🚀 开始生产环境部署..."

# 检查环境变量
if [ -z "$DATABASE_URL" ]; then
    echo "❌ 错误: DATABASE_URL 环境变量未设置"
    exit 1
fi

# 拉取最新代码
echo "📥 拉取最新代码..."
git pull origin main

# 构建Docker镜像
echo "🔨 构建Docker镜像..."
docker build -t safe-system:latest .

# 停止旧服务
echo "⏹️ 停止旧服务..."
docker-compose -f docker-compose.prod.yml down

# 启动新服务
echo "▶️ 启动新服务..."
docker-compose -f docker-compose.prod.yml up -d

# 等待服务启动
echo "⏳ 等待服务启动..."
sleep 30

# 健康检查
echo "🔍 执行健康检查..."
if curl -f http://localhost/health; then
    echo "✅ 部署成功!"
else
    echo "❌ 部署失败，执行回滚..."
    ./scripts/rollback.sh
    exit 1
fi

echo "🎉 生产环境部署完成!"
```

### 环境变量配置
```bash
# .env.production.template
# 数据库配置
DATABASE_URL=postgresql://username:password@hostname:5432/dbname
DB_HOST=your-db-host
DB_PORT=5432
DB_NAME=safe_prod
DB_USER=safe_user
DB_PASSWORD=your-secure-password

# Redis配置
REDIS_URL=redis://:password@hostname:6379/0
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# API配置
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=false
LOG_LEVEL=WARNING

# 安全配置
SECRET_KEY=your-super-secret-key-here
ACCESS_TOKEN_EXPIRE_MINUTES=30
ENVIRONMENT=production

# 腾讯云配置
TENCENT_SECRET_ID=your-secret-id
TENCENT_SECRET_KEY=your-secret-key
COS_BUCKET=your-bucket-name
COS_REGION=ap-beijing
```

### CI/CD配置示例
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest
    - name: Run tests
      run: pytest

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Deploy to production
      run: |
        # 配置SSH连接
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # 连接到服务器并部署
        ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "
          cd /opt/safe-system
          git pull origin main
          ./scripts/deploy-prod.sh
        "
```

### 监控和告警配置
```python
# 监控指标配置
METRICS_CONFIG = {
    'cpu_threshold': 80,        # CPU使用率阈值
    'memory_threshold': 85,     # 内存使用率阈值
    'disk_threshold': 90,       # 磁盘使用率阈值
    'response_time_threshold': 1.0,  # 响应时间阈值(秒)
    'error_rate_threshold': 0.01,   # 错误率阈值
}

# 告警配置
ALERT_CONFIG = {
    'email_enabled': True,
    'wechat_enabled': True,
    'email_recipients': ['admin@example.com'],
    'wechat_webhook': 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx'
}
```

### 开发工作流程
1. 申请腾讯云资源
2. 配置网络和安全组
3. 部署数据库和缓存服务
4. 配置对象存储
5. 部署应用服务
6. 配置域名和SSL证书
7. 设置CI/CD流水线
8. 配置监控和告警
9. 执行部署测试
10. 验证系统功能

### 依赖关系说明
- 依赖前面所有Stories完成的基础功能
- 为生产环境部署提供完整方案
- 为后续运维和扩展奠定基础

### 重要注意事项
- 腾讯云资源需要合理规划成本
- 安全组配置需要严格控制访问权限
- 数据库密码和密钥需要安全管理
- SSL证书需要定期更新
- 备份策略需要定期验证
- 监控告警需要及时响应

### 成本控制建议
- CVM实例选择按量计费开始，稳定后转为包年包月
- 数据库选择合适的规格，避免资源浪费
- COS设置合理的生命周期管理策略
- 监控告警避免产生不必要的费用

### 安全最佳实践
- 使用强密码和定期更换
- 启用数据库和Redis的SSL连接
- 配置防火墙规则限制不必要的访问
- 定期更新系统和软件补丁
- 实施访问日志审计

### Testing

#### 测试标准
- 测试文件位置: tests/deployment/目录
- 部署测试: 验证完整部署流程
- 环境测试: 验证生产环境配置
- 安全测试: 验证安全配置有效性
- 性能测试: 验证生产环境性能

#### 测试框架和模式
- 部署测试: 使用腾讯云测试环境
- 配置测试: pytest + 环境变量验证
- 安全测试: 使用安全扫描工具
- 性能测试: 使用压力测试工具

#### 特定测试要求
- 所有环境配置需要验证
- 部署脚本需要完整测试
- 数据库连接需要加密测试
- 监控告警需要实际测试
- 回滚机制需要验证

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)