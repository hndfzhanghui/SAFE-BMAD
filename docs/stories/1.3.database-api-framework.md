# Story 1.3: 数据库设计和基础API框架

## Status
Draft

## Story

**As a** 后端开发工程师,
**I want** 拥有完整的数据库设计和API框架,
**so that** 开始业务逻辑开发。

## Acceptance Criteria

1. 完成ER图设计，包含用户、场景、Agent、分析结果等核心实体
2. 创建数据库迁移脚本，支持版本化管理
3. FastAPI项目初始化，包含基础路由结构
4. SQLAlchemy ORM模型定义，支持基础CRUD操作
5. API文档自动生成(Swagger/OpenAPI)

## Tasks / Subtasks

- [ ] 设计数据库ER图和核心实体 (AC: #1)
  - [ ] 分析SAFE系统核心业务实体
    - [ ] 用户实体(User) - 系统用户信息
    - [ ] 应急场景实体(Scenario) - 应急事件数据
    - [ ] Agent状态实体(Agent) - 智能体状态信息
    - [ ] 分析结果实体(Analysis) - 分析结果数据
    - [ ] 决策记录实体(Decision) - 决策过程记录
    - [ ] 资源实体(Resource) - 救援资源信息
  - [ ] 设计实体关系和约束
    - [ ] 用户与场景的关系(多对多)
    - [ ] 场景与Agent的关系(一对多)
    - [ ] Agent与分析结果的关系(一对多)
    - [ ] 分析结果与决策的关系(一对多)
  - [ ] 创建ER图文档
    - [ ] 使用Mermaid语法绘制ER图
    - [ ] 保存到docs/database/er-diagram.md
    - [ ] 包含实体属性和关系说明
  - [ ] 设计数据库索引策略
    - [ ] 主键索引设计
    - [ ] 外键索引设计
    - [ ] 查询性能索引设计
    - [ ] 唯一性约束设计

- [ ] 创建数据库迁移系统 (AC: #2)
  - [ ] 选择迁移管理工具
    - [ ] Alembic - SQLAlchemy官方迁移工具
    - [ ] 配置Alembic环境
    - [ ] 创建迁移配置文件
  - [ ] 创建初始迁移脚本
    - [ ] 001_initial_schema.py - 创建所有表结构
    - [ ] 002_add_indexes.py - 创建索引
    - [   003_add_constraints.py - 添加约束
  - [ ] 建立迁移工作流程
    - [ ] migrate.sh - 数据库迁移脚本
    - [ ] rollback.sh - 回滚脚本
    - [ ] reset-db.sh - 重置数据库脚本
  - [ ] 配置迁移环境管理
    - [ ] 开发环境迁移配置
    - [ ] 测试环境迁移配置
    - [ ] 生产环境迁移配置
  - [ ] 创建迁移文档
    - [ ] docs/database/migrations.md - 迁移说明
    - [ ] 迁移最佳实践指南

- [ ] 初始化FastAPI项目 (AC: #3)
  - [ ] 创建FastAPI应用结构
    - [ ] main.py - 应用入口文件
    - [ ] app/ - 应用主目录
    - [   app/__init__.py - 应用初始化
    - [   app/core/ - 核心配置
    - [   app/api/ - API路由
    - [   app/db/ - 数据库相关
    - [   app/models/ - 数据模型
    - [   app/schemas/ - Pydantic模式
  - [ ] 配置FastAPI基础设置
    - [ ] 应用配置(config.py)
    - [ ] CORS配置
    - [ ] 中间件配置
    - [ ] 异常处理器配置
  - [ ] 创建基础路由结构
    - [   api/v1/ - API版本1路由
    - [   api/v1/__init__.py - 路由初始化
    - [   api/v1/endpoints/ - 端点定义
    - [   api/v1/api.py - 路由聚合
  - [ ] 配置依赖注入
    - [   dependencies/database.py - 数据库依赖
    - [   dependencies/security.py - 安全依赖
    - [   dependencies/common.py - 通用依赖
  - [ ] 创建应用启动脚本
    - [   run.py - 开发服务器启动
    - [   gunicorn.conf.py - 生产服务器配置

- [ ] 定义SQLAlchemy ORM模型 (AC: #4)
  - [ ] 创建基础模型类
    - [   models/base.py - 基础模型类
    - [   包含通用字段(id, created_at, updated_at)
    - [   包含通用方法(to_dict, from_dict等)
  - [ ] 实现核心实体模型
    - [   models/user.py - 用户模型
    - [   models/scenario.py - 场景模型
    - [   models/agent.py - Agent模型
    - [   models/analysis.py - 分析结果模型
    - [   models/decision.py - 决策记录模型
    - [   models/resource.py - 资源模型
  - [   实现关系模型
    - [   models/associations.py - 关联表模型
    - [   用户场景关联表
    - [   场景Agent关联表
    - [   其他多对多关系表
  - [ ] 实现CRUD基础操作
    - [   crud/base.py - 基础CRUD类
    - [   crud/user.py - 用户CRUD操作
    - [   crud/scenario.py - 场景CRUD操作
    - [   其他实体的CRUD操作
  - [   配置数据库会话管理
    - [   db/session.py - 数据库会话
    - [   db/database.py - 数据库连接
    - [   事务管理配置

- [ ] 实现基础API端点 (AC: #5)
  - [ ] 创建健康检查端点
    - [   GET /health - 基础健康检查
    - [   GET /ready - 就绪状态检查
    - [   GET /version - 版本信息
  - [   创建用户管理端点
    - [   POST /api/v1/users/ - 创建用户
    - [   GET /api/v1/users/ - 获取用户列表
    - [   GET /api/v1/users/{user_id} - 获取用户详情
    - [   PUT /api/v1/users/{user_id} - 更新用户
    - [   DELETE /api/v1/users/{user_id} - 删除用户
  - [   创建场景管理端点
    - [   POST /api/v1/scenarios/ - 创建场景
    - [   GET /api/v1/scenarios/ - 获取场景列表
    - [   GET /api/v1/scenarios/{scenario_id} - 获取场景详情
    - [   PUT /api/v1/scenarios/{scenario_id} - 更新场景
  - [   创建Agent状态端点
    - [   GET /api/v1/agents/ - 获取Agent状态列表
    - [   GET /api/v1/agents/{agent_type} - 获取特定Agent状态
    - [   PUT /api/v1/agents/{agent_type} - 更新Agent状态
  - [   实现分页和过滤
    - [   通用分页参数处理
    - [   查询过滤器实现
    - [   排序功能实现

- [ ] 配置API文档自动生成 (AC: #5)
  - [ ] 配置Swagger UI
    - [   启用OpenAPI文档生成
    - [   配置文档元信息
    - [   自定义文档样式
  - [   创建API文档
    - [   端点描述和示例
    - [   请求/响应模式定义
    - [   错误响应文档
  - [   配置ReDoc文档
    - [   备选文档界面
    - [   文档主题定制
  - [   创建API使用指南
    - [   docs/api/quick-start.md - 快速开始
    - [   docs/api/authentication.md - 认证指南
    - [   docs/api/examples.md - 使用示例

## Dev Notes

### 技术架构信息
数据库和API框架采用现代化技术栈：
- ORM: SQLAlchemy 2.0+ (支持异步操作)
- API框架: FastAPI 0.104+ (高性能异步框架)
- 数据库: PostgreSQL 14+ (主数据库)
- 迁移工具: Alembic (SQLAlchemy官方工具)
- 文档: OpenAPI 3.0 + Swagger UI + ReDoc

### ER图设计
```mermaid
erDiagram
    User ||--o{ Scenario : creates
    Scenario ||--o{ Agent : contains
    Agent ||--o{ Analysis : generates
    Analysis ||--o{ Decision : leads_to
    Scenario ||--o{ Resource : uses

    User {
        int id PK
        string username UK
        string email UK
        string password_hash
        timestamp created_at
        timestamp updated_at
        boolean is_active
        string role
    }

    Scenario {
        int id PK
        string name
        string type
        string status
        json metadata
        timestamp created_at
        timestamp updated_at
        int created_by FK
    }

    Agent {
        int id PK
        string agent_type UK
        string status
        json configuration
        timestamp last_updated
        json metadata
    }

    Analysis {
        int id PK
        int scenario_id FK
        int agent_id FK
        string analysis_type
        json results
        float confidence_score
        timestamp created_at
    }

    Decision {
        int id PK
        int analysis_id FK
        string decision_type
        json decision_data
        string status
        timestamp created_at
        int made_by FK
    }

    Resource {
        int id PK
        string name
        string type
        json properties
        string status
        timestamp created_at
        int scenario_id FK
    }
```

### FastAPI应用结构
```
app/
├── __init__.py
├── main.py                 # FastAPI应用入口
├── config.py              # 应用配置
├── core/                   # 核心配置
│   ├── __init__.py
│   ├── security.py         # 安全配置
│   └── config.py           # 核心配置类
├── api/                    # API路由
│   ├── __init__.py
│   ├── deps.py             # 依赖注入
│   └── v1/                 # API版本1
│       ├── __init__.py
│       ├── api.py          # 路由聚合
│       └── endpoints/      # 端点定义
│           ├── __init__.py
│           ├── users.py
│           ├── scenarios.py
│           └── agents.py
├── db/                     # 数据库相关
│   ├── __init__.py
│   ├── session.py          # 数据库会话
│   ├── database.py         # 数据库连接
│   └── base.py             # 基础数据库类
├── models/                 # ORM模型
│   ├── __init__.py
│   ├── base.py             # 基础模型类
│   ├── user.py
│   ├── scenario.py
│   ├── agent.py
│   └── analysis.py
├── schemas/                # Pydantic模式
│   ├── __init__.py
│   ├── user.py
│   ├── scenario.py
│   └── common.py           # 通用模式
└── crud/                   # CRUD操作
    ├── __init__.py
    ├── base.py             # 基础CRUD类
    ├── user.py
    └── scenario.py
```

### 数据库模型示例
```python
# models/base.py
from sqlalchemy import Column, Integer, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func

Base = declarative_base()

class BaseModel(Base):
    __abstract__ = True

    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

# models/user.py
from sqlalchemy import Column, String, Boolean
from .base import BaseModel

class User(BaseModel):
    __tablename__ = "users"

    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    is_active = Column(Boolean, default=True)
    role = Column(String(20), default="user")
```

### API端点示例
```python
# api/v1/endpoints/users.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
from app.api.deps import get_db
from app.crud.user import user_crud
from app.schemas.user import UserCreate, UserResponse, UserUpdate

router = APIRouter()

@router.post("/", response_model=UserResponse)
def create_user(
    user: UserCreate,
    db: Session = Depends(get_db)
):
    db_user = user_crud.get_by_email(db, email=user.email)
    if db_user:
        raise HTTPException(status_code=400, detail="Email already registered")
    return user_crud.create(db=db, obj_in=user)

@router.get("/", response_model=List[UserResponse])
def read_users(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    users = user_crud.get_multi(db, skip=skip, limit=limit)
    return users
```

### 迁移脚本示例
```python
# alembic/versions/001_initial_schema.py
"""Initial schema

Revision ID: 001
Revises:
Create Date: 2025-10-20 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = '001'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # Create users table
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(length=50), nullable=False),
        sa.Column('email', sa.String(length=100), nullable=False),
        sa.Column('password_hash', sa.String(length=255), nullable=False),
        sa.Column('is_active', sa.Boolean(), nullable=True),
        sa.Column('role', sa.String(length=20), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_username'), 'users', ['username'], unique=True)

def downgrade():
    op.drop_index(op.f('ix_users_username'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
```

### 配置文件示例
```python
# app/core/config.py
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # Database
    DATABASE_URL: str = "postgresql://safe_user:safe_password@localhost/safe_dev"

    # API
    API_V1_STR: str = "/api/v1"
    PROJECT_NAME: str = "SAFE System"

    # Security
    SECRET_KEY: str = "your-secret-key-here"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30

    # CORS
    BACKEND_CORS_ORIGINS: list = ["http://localhost:3000"]

    class Config:
        env_file = ".env"

settings = Settings()
```

### 开发工作流程
1. 设计数据库模型和关系
2. 创建迁移脚本: `alembic revision --autogenerate -m "描述"`
3. 应用迁移: `alembic upgrade head`
4. 实现SQLAlchemy模型
5. 创建Pydantic模式
6. 实现CRUD操作
7. 创建API端点
8. 编写测试用例
9. 更新API文档

### 依赖关系说明
- 依赖Story 1.1完成的项目结构
- 依赖Story 1.2完成的开发环境
- 为Story 1.4日志监控提供数据模型
- 为后续业务逻辑开发提供基础框架

### 重要注意事项
- 数据库设计需要考虑未来的扩展性
- API设计需要遵循RESTful规范
- 所有API端点都需要适当的错误处理
- 敏感信息需要加密存储
- 数据库操作需要考虑事务管理
- API文档需要保持更新

### 性能优化建议
- 合理使用数据库索引
- 实现查询结果缓存
- 使用连接池管理数据库连接
- 实现API响应缓存
- 考虑数据库读写分离

### Testing

#### 测试标准
- 测试文件位置: tests/目录下按模块分类
- 单元测试: tests/unit/ - 测试单个函数和类
- 集成测试: tests/integration/ - 测试组件间集成
- API测试: tests/api/ - 测试API端点
- 数据库测试: tests/db/ - 测试数据库操作

#### 测试框架和模式
- 单元测试: pytest + pytest-asyncio
- 数据库测试: pytest + pytest-postgresql
- API测试: pytest + httpx + FastAPI TestClient
- 测试数据库: 使用pytest fixtures创建测试数据库

#### 特定测试要求
- 所有模型类需要单元测试
- 所有API端点需要集成测试
- 数据库迁移需要测试
- CRUD操作需要完整测试
- 错误处理需要测试覆盖

#### 测试示例
```python
# tests/test_users.py
import pytest
from fastapi.testclient import TestClient
from sqlalchemy.orm import Session

from app.main import app
from app.api.deps import get_db
from app.core.config import settings

def test_create_user(client: TestClient):
    user_data = {
        "username": "testuser",
        "email": "test@example.com",
        "password": "testpassword123"
    }
    response = client.post(f"{settings.API_V1_STR}/users/", json=user_data)
    assert response.status_code == 200
    data = response.json()
    assert data["username"] == user_data["username"]
    assert data["email"] == user_data["email"]
    assert "id" in data

def test_read_users(client: TestClient):
    response = client.get(f"{settings.API_V1_STR}/users/")
    assert response.status_code == 200
    assert isinstance(response.json(), list)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)