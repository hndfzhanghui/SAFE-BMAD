# Story 3.2: S-Agent战略分析能力实现

## Status
Draft

## Story

**As a** 应急决策系统,
**I want** S-Agent能够基于模拟数据生成高质量的战略分析框架,
**so that** 为整个多Agent系统提供明确的战略指导和决策方向。

## Acceptance Criteria

1. S-Agent能够处理模拟的应急场景数据并分析态势严重程度
2. 基于分析结果生成多层次的战略目标和优先级建议
3. 识别关键决策节点和时间窗口
4. 提供结构化的战略分析框架和决策依据
5. 输出符合决策者理解习惯的战略指导文档

## Tasks / Subtasks

- [ ] 实现战略分析核心引擎 (AC: #1)
  - [ ] 设计态势严重程度评估模型
    - [ ] 严重程度指标体系
    - [ ] 多维度权重计算算法
    - [ ] 动态评估机制
    - [ ] 历史对比分析器
  - [ ] 实现战略目标识别算法
    - [ ] 目标层次结构分析
    - [ ] 目标优先级排序
    - [ ] 目标可行性评估
    - [ ] 目标冲突检测器
  - [ ] 创建决策节点识别器
    - [ ] 关键决策点检测
    - [ ] 决策依赖关系分析
    - [ ] 决策影响范围评估
    - [ ] 决策紧迫性计算
  - [ ] 实现时间窗口规划器
    - [ ] 时间窗口识别
    - [ ] 时间约束分析
    - [ ] 时序依赖建模
    - [ ] 时间优化算法
  - [ ] 设计战略框架生成器
    - [ ] 框架结构设计
    - [ ] 内容组织逻辑
    - [ ] 可视化展示器
    - [ ] 框架优化器

- [ ] 实现态势严重程度评估 (AC: #2)
  - [ ] 设计评估指标体系
    - [ ] 人员安全指标
    - [ ] 基础设施指标
    - [ ] 环境影响指标
    - [ ] 社会稳定指标
  - [ ] 实现多维度数据融合
    - [ ] 数据标准化处理
    - [ ] 权重分配算法
    - [ ] 融合计算引擎
    - [ ] 一致性检查器
  - [ ] 创建动态评估机制
    - [ ] 实时数据更新
    - [ ] 趋势变化检测
    - [ ] 异常情况处理
    - [ ] 预警触发器
  - [ ] 实现严重程度分级
    - [ ] 分级标准定义
    - [ ] 自动分级算法
    - [ ] 分级调整机制
    - [ ] 分级验证器
  - [ ] 设计历史对比分析
    - [ ] 历史案例匹配
    - [ ] 相似度计算
    - [ ] 经验知识提取
    - [ ] 对比报告生成

- [ ] 实现战略目标生成 (AC: #3)
  - [ ] 设计目标层次结构
    - [ ] 总体目标定义
    - [ ] 分解目标识别
    - [ ] 目标层次建模
    - [ ] 目标关系映射
  - [ ] 实现目标优先级算法
    - [ ] 优先级评估模型
    - [ ] 多标准决策分析
    - [ ] 权重动态调整
    - [ ] 优先级验证器
  - [ ] 创建目标可行性评估
    - [ ] 资源需求分析
    - [ ] 时间约束评估
    - [ ] 技术可行性分析
    - [ ] 风险评估模型
  - [ ] 实现目标冲突检测
    - [ ] 冲突识别算法
    - [ ] 冲突类型分类
    - [ ] 冲突解决策略
    - [ ] 冲突协调机制
  - [ ] 设计目标优化建议器
    - [ ] 目标调整建议
    - [ ] 资源优化配置
    - [ ] 时间优化建议
    - [ ] 效果预测模型

- [ ] 实现决策支持功能 (AC: #4)
  - [ ] 设计决策建议生成器
    - [ ] 建议模板管理
    - [ ] 内容生成算法
    - [ ] 建议质量评估
    - [ ] 建议优化器
  - [ ] 实现决策依据说明
    - [ ] 推理过程记录
    - [ ] 证据链构建
    - [ ] 逻辑验证器
    - [ ] 解释生成器
  - [ ] 创建风险评估系统
    - [ ] 风险识别算法
    - [ ] 风险概率计算
    - [ ] 风险影响评估
    - [ ] 风险缓解建议
  - [ ] 实现敏感性分析
    - [ ] 参数敏感性测试
    - [ ] 场景变化分析
    - [ ] 稳定性评估
    - [ ] 敏感性报告生成
  - [ ] 设计决策跟踪器
    - [ ] 决策执行监控
    - [ ] 效果跟踪分析
    - [ ] 偏差检测器
    - [ ] 调整建议生成

- [ ] 实现输出和展示 (AC: #5)
  - [ ] 设计战略数据模型
    - [ ] StrategicFramework数据结构
    - [ ] StrategicGoal目标结构
    - [ ] DecisionNode决策节点结构
    - [ ] TimeWindow时间窗口结构
  - [ ] 实现结构化输出
    - [ ] JSON格式输出
    - [ ] XML格式支持
    - [ ] 自定义格式扩展
    - [ ] 输出验证器
  - [ ] 创建可视化组件
    - [ ] 战略框架图表
    - [ ] 目标层次图
    - [ ] 时间轴展示
    - [ ] 决策流程图
  - [ ] 实现报告生成器
    - [ ] 报告模板管理
    - [ ] 内容自动填充
    - [ ] 图表自动生成
    - [ ] 报告质量控制
  - [ ] 设计交互式界面
    - [ ] 参数调整接口
    - [ ] 实时预览功能
    - [ ] 导出功能
    - [ ] 分享机制

## Dev Notes

### 技术架构信息
S-Agent战略分析采用以下技术栈：
- AI框架: DeepSeek V3 + LangChain
- 决策算法: 多标准决策分析 (MCDA) + 层次分析法 (AHP)
- 数据处理: Pandas + NumPy + Scikit-learn
- 时间分析: Prophet + 时间序列分析
- 可视化: Plotly + Matplotlib
- 知识管理: Neo4j + 向量数据库

### S-Agent核心设计
```python
from typing import Dict, List, Any, Optional, Tuple, Set
from dataclasses import dataclass, field
from enum import Enum
import json
import asyncio
import time
from datetime import datetime, timedelta
from abc import ABC, abstractmethod
import numpy as np
import pandas as pd
from sklearn.preprocessing import StandardScaler
from sklearn.cluster import KMeans

class SeverityLevel(Enum):
    """严重程度等级枚举"""
    EXTREME = 1     # 极端严重
    SEVERE = 2      # 严重
    MODERATE = 3    # 中等
    MINOR = 4       # 轻微
    NEGLIGIBLE = 5  # 可忽略

class GoalPriority(Enum):
    """目标优先级枚举"""
    CRITICAL = 1    # 关键目标
    HIGH = 2        # 高优先级
    MEDIUM = 3      # 中等优先级
    LOW = 4         # 低优先级

class DecisionType(Enum):
    """决策类型枚举"""
    STRATEGIC = "strategic"     # 战略决策
    TACTICAL = "tactical"       # 战术决策
    OPERATIONAL = "operational" # 操作决策
    EMERGENCY = "emergency"     # 紧急决策

@dataclass
class SeverityAssessment:
    """严重程度评估数据模型"""
    assessment_id: str
    scenario_id: str
    assessment_timestamp: datetime

    # 总体严重程度
    overall_severity: SeverityLevel
    severity_score: float  # 0-1之间

    # 分维度评估
    personnel_safety: float  # 人员安全评分
    infrastructure_damage: float  # 基础设施损毁评分
    environmental_impact: float  # 环境影响评分
    social_stability: float  # 社会稳定性评分

    # 关键指标
    affected_population: int
    economic_loss: float
    response_time_critical: bool

    # 趋势分析
    trend_direction: str  # improving, stable, deteriorating
    trend_confidence: float

    # 历史对比
    historical_comparison: Dict[str, Any]

    # 评估依据
    supporting_evidence: List[Dict[str, Any]]
    confidence_level: float

@dataclass
class StrategicGoal:
    """战略目标数据模型"""
    goal_id: str
    goal_name: str
    description: str
    priority: GoalPriority

    # 目标层次
    level: int  # 1-总体目标, 2-分项目标, 3-具体目标
    parent_goal_id: Optional[str]
    sub_goal_ids: List[str]

    # 时间约束
    target_completion_time: Optional[datetime]
    critical_time_window: Tuple[datetime, datetime]

    # 资源需求
    required_resources: Dict[str, Any]
    resource_priority: int

    # 可行性分析
    feasibility_score: float
    risk_level: float

    # 衡量指标
    success_metrics: List[Dict[str, Any]]
    current_progress: float

    # 关联信息
    dependencies: List[str]
    conflicts: List[str]

    # 元数据
    creation_timestamp: datetime
    last_updated: datetime

@dataclass
class DecisionNode:
    """决策节点数据模型"""
    node_id: str
    node_name: str
    decision_type: DecisionType
    description: str

    # 时间属性
    decision_time: datetime
    deadline: Optional[datetime]
    time_criticality: float

    # 决策内容
    decision_options: List[Dict[str, Any]]
    recommended_option: Optional[str]

    # 影响分析
    impact_scope: Dict[str, Any]
    affected_goals: List[str]
    consequences: List[Dict[str, Any]]

    # 决策依据
    supporting_data: List[Dict[str, Any]]
    confidence_level: float

    # 关联关系
    dependencies: List[str]
    follow_up_decisions: List[str]

    # 状态
    status: str  # pending, made, implemented, completed

@dataclass
class StrategicFramework:
    """战略框架数据模型"""
    framework_id: str
    scenario_id: str
    creation_timestamp: datetime

    # 严重程度评估
    severity_assessment: SeverityAssessment

    # 战略目标体系
    strategic_goals: List[StrategicGoal]
    goal_hierarchy: Dict[str, Any]

    # 决策节点
    decision_nodes: List[DecisionNode]
    decision_flow: Dict[str, Any]

    # 时间规划
    time_windows: List[Dict[str, Any]]
    critical_path: List[str]

    # 行动建议
    immediate_actions: List[Dict[str, Any]]
    strategic_recommendations: List[Dict[str, Any]]

    # 风险评估
    risk_assessment: Dict[str, Any]
    contingency_plans: List[Dict[str, Any]]

    # 质量指标
    framework_coherence: float
    action_feasibility: float
    resource_adequacy: float

class SAgentImplementation:
    """S-Agent战略分析实现"""

    def __init__(self, config: Dict[str, Any]):
        self.config = config

        # 分析组件
        self.severity_analyzer = SeverityAnalyzer()
        self.goal_generator = GoalGenerator()
        self.decision_analyzer = DecisionAnalyzer()
        self.time_planner = TimePlanner()
        self.risk_assessor = RiskAssessor()

        # 知识库
        self.strategic_knowledge_base = StrategicKnowledgeBase()
        self.historical_cases = HistoricalCaseBase()
        self.decision_templates = DecisionTemplateBase()

        # 评估模型
        self.severity_model = SeverityAssessmentModel()
        self.priority_model = PriorityAssessmentModel()
        self.feasibility_model = FeasibilityAssessmentModel()

    async def generate_strategic_framework(self, scenario_data: Dict[str, Any]) -> StrategicFramework:
        """生成战略分析框架"""
        start_time = time.time()

        try:
            # 步骤1: 评估态势严重程度
            severity_assessment = await self.severity_analyzer.assess_severity(scenario_data)

            # 步骤2: 生成战略目标
            strategic_goals = await self.goal_generator.generate_goals(
                scenario_data, severity_assessment
            )

            # 步骤3: 识别关键决策节点
            decision_nodes = await self.decision_analyzer.identify_decision_nodes(
                scenario_data, strategic_goals
            )

            # 步骤4: 制定时间规划
            time_windows = await self.time_planner.plan_time_windows(
                strategic_goals, decision_nodes
            )

            # 步骤5: 评估风险和制定应急预案
            risk_assessment = await self.risk_assessor.assess_risks(
                scenario_data, strategic_goals, decision_nodes
            )

            # 步骤6: 生成战略建议
            strategic_recommendations = await self._generate_strategic_recommendations(
                severity_assessment, strategic_goals, decision_nodes
            )

            # 步骤7: 构建完整框架
            framework = StrategicFramework(
                framework_id=f"strategic_{int(time.time())}",
                scenario_id=scenario_data.get('scenario_id'),
                creation_timestamp=datetime.now(),
                severity_assessment=severity_assessment,
                strategic_goals=strategic_goals,
                goal_hierarchy=self._build_goal_hierarchy(strategic_goals),
                decision_nodes=decision_nodes,
                decision_flow=self._build_decision_flow(decision_nodes),
                time_windows=time_windows,
                critical_path=self._identify_critical_path(decision_nodes, time_windows),
                immediate_actions=strategic_recommendations['immediate'],
                strategic_recommendations=strategic_recommendations['strategic'],
                risk_assessment=risk_assessment,
                contingency_plans=strategic_recommendations['contingency'],
                framework_coherence=self._assess_framework_coherence(strategic_goals, decision_nodes),
                action_feasibility=self._assess_action_feasibility(strategic_goals),
                resource_adequacy=self._assess_resource_adequacy(strategic_goals)
            )

            # 记录分析时间
            analysis_time = time.time() - start_time
            logger.info(f"S-Agent strategic analysis completed in {analysis_time:.2f} seconds")

            return framework

        except Exception as e:
            logger.error(f"S-Agent strategic analysis failed: {e}")
            raise

    async def _generate_strategic_recommendations(self,
                                                 severity_assessment: SeverityAssessment,
                                                 strategic_goals: List[StrategicGoal],
                                                 decision_nodes: List[DecisionNode]) -> Dict[str, Any]:
        """生成战略建议"""
        try:
            recommendations = {
                'immediate': [],
                'strategic': [],
                'contingency': []
            }

            # 基于严重程度生成立即行动建议
            if severity_assessment.overall_severity in [SeverityLevel.EXTREME, SeverityLevel.SEVERE]:
                immediate_actions = await self._generate_emergency_actions(severity_assessment)
                recommendations['immediate'].extend(immediate_actions)

            # 基于战略目标生成中长期建议
            strategic_actions = await self._generate_strategic_actions(strategic_goals)
            recommendations['strategic'].extend(strategic_actions)

            # 基于风险评估生成应急预案
            contingency_plans = await self._generate_contingency_plans(decision_nodes)
            recommendations['contingency'].extend(contingency_plans)

            return recommendations

        except Exception as e:
            logger.error(f"Failed to generate strategic recommendations: {e}")
            return {'immediate': [], 'strategic': [], 'contingency': []}

class SeverityAnalyzer:
    """严重程度分析器"""

    def __init__(self):
        self.evaluation_metrics = {
            'personnel_safety': PersonnelSafetyEvaluator(),
            'infrastructure_damage': InfrastructureDamageEvaluator(),
            'environmental_impact': EnvironmentalImpactEvaluator(),
            'social_stability': SocialStabilityEvaluator()
        }
        self.historical_comparator = HistoricalComparator()
        self.trend_analyzer = TrendAnalyzer()

    async def assess_severity(self, scenario_data: Dict[str, Any]) -> SeverityAssessment:
        """评估态势严重程度"""
        try:
            # 收集评估所需数据
            evaluation_data = await self._collect_evaluation_data(scenario_data)

            # 各维度评估
            dimension_scores = {}
            for metric_name, evaluator in self.evaluation_metrics.items():
                score = await evaluator.evaluate(evaluation_data)
                dimension_scores[metric_name] = score

            # 计算总体严重程度
            overall_score = await self._calculate_overall_severity(dimension_scores)
            severity_level = self._classify_severity_level(overall_score)

            # 趋势分析
            trend_analysis = await self.trend_analyzer.analyze_trend(evaluation_data)

            # 历史对比
            historical_comparison = await self.historical_comparator.compare_with_history(
                evaluation_data, severity_level
            )

            # 生成评估依据
            supporting_evidence = await self._generate_supporting_evidence(
                dimension_scores, evaluation_data
            )

            return SeverityAssessment(
                assessment_id=f"severity_{int(time.time())}",
                scenario_id=scenario_data.get('scenario_id'),
                assessment_timestamp=datetime.now(),
                overall_severity=severity_level,
                severity_score=overall_score,
                personnel_safety=dimension_scores['personnel_safety'],
                infrastructure_damage=dimension_scores['infrastructure_damage'],
                environmental_impact=dimension_scores['environmental_impact'],
                social_stability=dimension_scores['social_stability'],
                affected_population=evaluation_data.get('affected_population', 0),
                economic_loss=evaluation_data.get('economic_loss', 0.0),
                response_time_critical=evaluation_data.get('response_time_critical', False),
                trend_direction=trend_analysis['direction'],
                trend_confidence=trend_analysis['confidence'],
                historical_comparison=historical_comparison,
                supporting_evidence=supporting_evidence,
                confidence_level=self._calculate_confidence_level(dimension_scores)
            )

        except Exception as e:
            logger.error(f"Failed to assess severity: {e}")
            raise

class GoalGenerator:
    """战略目标生成器"""

    def __init__(self):
        self.goal_templates = GoalTemplateBase()
        self.priority_analyzer = PriorityAnalyzer()
        self.feasibility_analyzer = FeasibilityAnalyzer()
        self.dependency_analyzer = DependencyAnalyzer()

    async def generate_goals(self, scenario_data: Dict[str, Any],
                           severity_assessment: SeverityAssessment) -> List[StrategicGoal]:
        """生成战略目标"""
        try:
            goals = []

            # 根据严重程度确定目标类型和数量
            goal_types = await self._determine_goal_types(severity_assessment)

            # 生成总体目标
            primary_goals = await self._generate_primary_goals(goal_types, scenario_data)
            goals.extend(primary_goals)

            # 生成分项目标
            for primary_goal in primary_goals:
                sub_goals = await self._generate_sub_goals(primary_goal, scenario_data)
                goals.extend(sub_goals)

            # 生成具体目标
            for goal in goals:
                if goal.level < 3:
                    specific_goals = await self._generate_specific_goals(goal, scenario_data)
                    goals.extend(specific_goals)

            # 分析目标优先级
            for goal in goals:
                goal.priority = await self.priority_analyzer.analyze_priority(goal, scenario_data)

            # 评估可行性
            for goal in goals:
                goal.feasibility_score = await self.feasibility_analyzer.assess_feasibility(
                    goal, scenario_data
                )

            # 分析依赖关系
            dependency_analysis = await self.dependency_analyzer.analyze_dependencies(goals)
            for goal in goals:
                goal.dependencies = dependency_analysis[goal.goal_id]['dependencies']
                goal.conflicts = dependency_analysis[goal.goal_id]['conflicts']

            return goals

        except Exception as e:
            logger.error(f"Failed to generate goals: {e}")
            raise

    async def _generate_primary_goals(self, goal_types: List[str],
                                    scenario_data: Dict[str, Any]) -> List[StrategicGoal]:
        """生成总体目标"""
        try:
            primary_goals = []

            for goal_type in goal_types:
                template = await self.goal_templates.get_template(goal_type, 'primary')

                goal = StrategicGoal(
                    goal_id=f"goal_primary_{goal_type}_{int(time.time())}",
                    goal_name=template['name'],
                    description=template['description'],
                    priority=GoalPriority.CRITICAL,
                    level=1,
                    parent_goal_id=None,
                    sub_goal_ids=[],
                    target_completion_time=datetime.now() + timedelta(hours=template['time_horizon']),
                    critical_time_window=(
                        datetime.now(),
                        datetime.now() + timedelta(hours=template['critical_window'])
                    ),
                    required_resources=template['resource_requirements'],
                    resource_priority=1,
                    feasibility_score=0.8,  # 初始评估，后续会更新
                    risk_level=template['risk_level'],
                    success_metrics=template['success_metrics'],
                    current_progress=0.0,
                    dependencies=[],
                    conflicts=[],
                    creation_timestamp=datetime.now(),
                    last_updated=datetime.now()
                )

                primary_goals.append(goal)

            return primary_goals

        except Exception as e:
            logger.error(f"Failed to generate primary goals: {e}")
            raise

class DecisionAnalyzer:
    """决策分析器"""

    def __init__(self):
        self.decision_patterns = DecisionPatternBase()
        self.impact_analyzer = ImpactAnalyzer()
        self.option_evaluator = OptionEvaluator()
        self.timing_analyzer = TimingAnalyzer()

    async def identify_decision_nodes(self, scenario_data: Dict[str, Any],
                                    strategic_goals: List[StrategicGoal]) -> List[DecisionNode]:
        """识别关键决策节点"""
        try:
            decision_nodes = []

            # 基于战略目标识别决策节点
            for goal in strategic_goals:
                goal_decisions = await self._identify_goal_decisions(goal, scenario_data)
                decision_nodes.extend(goal_decisions)

            # 基于场景特征识别决策节点
            scenario_decisions = await self._identify_scenario_decisions(scenario_data)
            decision_nodes.extend(scenario_decisions)

            # 去重和优化
            decision_nodes = await self._optimize_decision_nodes(decision_nodes)

            # 分析决策影响
            for decision in decision_nodes:
                decision.impact_scope = await self.impact_analyzer.analyze_impact(
                    decision, scenario_data, strategic_goals
                )
                decision.confidence_level = await self._calculate_decision_confidence(decision)

            return decision_nodes

        except Exception as e:
            logger.error(f"Failed to identify decision nodes: {e}")
            raise

    async def _identify_goal_decisions(self, goal: StrategicGoal,
                                     scenario_data: Dict[str, Any]) -> List[DecisionNode]:
        """识别与目标相关的决策节点"""
        try:
            decisions = []

            # 根据目标类型识别关键决策
            if "生命安全" in goal.goal_name:
                # 救援相关决策
                rescue_decisions = await self._generate_rescue_decisions(goal, scenario_data)
                decisions.extend(rescue_decisions)

            elif "基础设施" in goal.goal_name:
                # 基础设施相关决策
                infrastructure_decisions = await self._generate_infrastructure_decisions(
                    goal, scenario_data
                )
                decisions.extend(infrastructure_decisions)

            elif "环境" in goal.goal_name:
                # 环境保护相关决策
                environmental_decisions = await self._generate_environmental_decisions(
                    goal, scenario_data
                )
                decisions.extend(environmental_decisions)

            return decisions

        except Exception as e:
            logger.error(f"Failed to identify goal decisions: {e}")
            raise
```

### 开发工作流程
1. 接收模拟场景数据和历史案例信息
2. 评估当前态势的严重程度和影响范围
3. 基于严重程度和场景特征生成多层次战略目标
4. 识别关键决策节点和时间窗口
5. 制定时间规划和执行路径
6. 评估风险并生成应急预案
7. 构建完整的战略分析框架
8. 输出结构化的战略指导文档

### 依赖关系说明
- 依赖Story 3.1提供的模拟场景数据
- 与A-Agent、F-Agent、E-Agent保持信息同步
- 为整个SAFE系统提供战略指导基础

### 重要注意事项
- 战略分析必须基于充分的数据支持和历史经验
- 目标设置需要兼顾现实性和挑战性
- 决策节点识别需要考虑时间紧迫性
- 风险评估需要全面覆盖各类风险因素
- 框架输出需要符合决策者的理解习惯

### 测试策略
- 单元测试: 测试各种分析算法的准确性
- 集成测试: 测试完整的战略分析流程
- 专家评估: 邀请应急专家评估分析质量
- 历史回测: 使用历史案例验证分析效果

### Testing

#### 测试标准
- 测试文件位置: tests/s_agent/目录
- 严重程度评估测试: 验证评估结果的准确性
- 目标生成测试: 验证目标的合理性和可行性
- 决策节点识别测试: 验证关键决策的识别准确性
- 时间规划测试: 验证时间窗口的合理性

#### 测试框架和模式
- 单元测试: pytest + numpy.testing
- 集成测试: pytest + 模拟场景数据
- 专家评估: 专家评审 + 问卷调查
- 历史验证: 历史案例对比分析

#### 特定测试要求
- 不同严重程度场景的评估准确性测试
- 战略目标层次结构的合理性测试
- 决策节点时间紧迫性的准确性测试
- 战略框架逻辑一致性的验证测试
- 与其他Agent协作的接口测试

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)