# Story 1.4: 基础日志和监控系统

## Status
Approved

## Story

**As a** 运维工程师,
**I want** 拥有基础的日志记录和系统监控,
**so that** 及时发现和解决问题。

## Acceptance Criteria

1. 结构化日志记录系统(loguru/structlog)
2. 系统健康检查接口(/health, /ready)
3. 基础性能监控(响应时间、错误率、资源使用)
4. 日志轮转和存储配置
5. 基础告警机制(邮件/企业微信)

## Tasks / Subtasks

- [ ] 实现结构化日志记录系统 (AC: #1)
  - [ ] 选择日志框架和配置
    - [ ] 使用loguru作为主要日志框架
    - [ ] 配置structlog作为备选方案
    - [ ] 创建日志配置文件
    - [ ] 配置不同环境的日志级别
  - [ ] 设计日志格式和结构
    - [ ] 定义标准日志字段(timestamp, level, message, module等)
    - [ ] 添加请求追踪ID
    - [ ] 添加用户信息和上下文
    - [ ] 配置JSON格式输出
  - [ ] 创建日志记录中间件
    - [ ] FastAPI日志中间件
    - [ ] 请求/响应日志记录
    - [ ] 异常捕获和记录
    - [ ] 性能指标记录
  - [ ] 配置多环境日志
    - [ ] 开发环境日志配置
    - [ ] 测试环境日志配置
    - [ ] 生产环境日志配置
  - [ ] 实现日志工具类
    - [ ] 封装常用日志方法
    - [ ] 支持异步日志记录
    - [ ] 支持日志采样和过滤

- [ ] 实现系统健康检查接口 (AC: #2)
  - [ ] 创建健康检查端点
    - [ ] GET /health - 基础健康检查
    - [ ] GET /ready - 就绪状态检查
    - [ ] GET /live - 存活状态检查
    - [ ] GET /metrics - 基础指标
  - [ ] 实现健康检查逻辑
    - [ ] 数据库连接检查
    - [ ] Redis连接检查
    - [ ] 外部服务依赖检查
    - [ ] 系统资源检查
  - [ ] 配置健康检查响应格式
    - [ ] 标准化响应结构
    - [ ] 包含详细状态信息
    - [ ] 包含检查时间戳
    - [ ] 包含服务版本信息
  - [ ] 实现健康检查缓存
    - [ ] 避免频繁检查造成的性能问题
    - [ ] 配置检查间隔
    - [ ] 实现缓存失效机制
  - [ ] 创建健康检查文档
    - [ ] docs/health-check.md - 使用说明
    - [ ] 集成配置指南

- [ ] 实现基础性能监控 (AC: #3)
  - [ ] 选择监控指标收集方案
    - [ ] 使用Prometheus客户端库
    - [ ] 配置自定义指标
    - [ ] 设置指标标签和维度
  - [ ] 实现API性能监控
    - [ ] 请求响应时间监控
    - [ ] 请求速率监控
    - [ ] 错误率监控
    - [ ] 并发连接数监控
  - [ ] 实现系统资源监控
    - [ ] CPU使用率监控
    - [ ] 内存使用率监控
    - [ ] 磁盘I/O监控
    - [ ] 网络I/O监控
  - [ ] 实现业务指标监控
    - [ ] Agent处理时间监控
    - [ ] 数据库查询性能监控
    - [ ] 缓存命中率监控
    - [ ] 用户活跃度监控
  - [ ] 配置指标暴露端点
    - [ ] GET /metrics - Prometheus指标
    - [ ] 指标格式化输出
    - [ ] 指标标签规范化

- [ ] 配置日志轮转和存储 (AC: #4)
  - [ ] 配置日志轮转策略
    - [ ] 按时间轮转(daily/weekly)
    - [ ] 按大小轮转(max size)
    - [ ] 保留策略(retention)
    - [ ] 压缩策略(compression)
  - [ ] 配置日志存储
    - [ ] 本地文件存储配置
    - [ ] 日志目录结构
    - [ ] 文件权限配置
    - [ ] 存储空间监控
  - [ ] 实现日志归档机制
    - [ ] 自动归档策略
    - [ ] 归档文件命名规则
    - [ ] 归档位置配置
    - [ ] 归档清理机制
  - [ ] 配置Docker环境日志
    - [ ] 容器日志驱动配置
    - [ ] 日志收集配置
    - [ ] 日志转发配置
    - [ ] 日志聚合配置
  - [ ] 创建日志管理脚本
    - [ ] logs/rotate.sh - 日志轮转脚本
    - [ ] logs/cleanup.sh - 日志清理脚本
    - [ ] logs/archive.sh - 日志归档脚本

- [ ] 实现基础告警机制 (AC: #5)
  - [ ] 选择告警通知渠道
    - [ ] 邮件告警配置
    - [ ] 企业微信告警配置
    - [ ] 钉钉告警配置(可选)
    - [ ] Slack告警配置(可选)
  - [ ] 实现告警规则引擎
    - [ ] 阈值告警规则
    - [ ] 趋势告警规则
    - [ ] 异常检测告警
    - [ ] 自定义告警规则
  - [ ] 创建告警管理模块
    - [ ] 告警规则配置
    - [ ] 告警级别管理
    - [ ] 告警抑制机制
    - [ ] 告警升级机制
  - [ ] 实现告警通知服务
    - [ ] 邮件通知服务
    - [ ] 即时消息通知服务
    - [ ] 短信通知服务(可选)
    - [ ] 告警通知模板
  - [ ] 配置告警测试
    - [ ] 告警测试脚本
    - [ ] 告警模拟器
    - [ ] 告警通知测试
    - [ ] 告警恢复测试

## 开发技术指引

### 核心技术栈
- 日志框架: loguru (结构化日志) + structlog (备选)
- 监控指标: Prometheus + prometheus-client
- 健康检查: FastAPI + AutoGen服务状态监控
- 告警通知: 多渠道告警 (邮件/企业微信/钉钉)
- 日志存储: 本地文件 + 可选ELK集成

### 关键监控接口
```python
# 健康检查核心接口
@router.get("/health")
async def health_check():
    """基础健康检查"""
    return {
        "status": "healthy",
        "timestamp": time.time(),
        "version": "SAFE-Multi-Agent-System",
        "agents": await get_agent_status()
    }

@router.get("/ready")
async def readiness_check():
    """就绪状态检查"""
    checks = {
        "database": await check_database(),
        "redis": await check_redis(),
        "autogen_agents": await check_autogen_agents(),
        "ai_model": await check_ai_model_connection()
    }
    return {
        "status": "ready" if all(v == "healthy" for v in checks.values()) else "not_ready",
        "timestamp": time.time(),
        "checks": checks
    }
```

### AutoGen智能体监控指标
```python
# Agent协作监控指标
AGENT_PROCESSING_TIME = Histogram(
    'agent_processing_duration_seconds',
    'Agent processing duration',
    ['agent_type', 'task_type']
)

SOP_WORKFLOW_DURATION = Histogram(
    'sop_workflow_duration_seconds',
    'SOP workflow completion time',
    ['workflow_name', 'severity_level']
)

PLAN_TASK_STATUS = Gauge(
    'plan_task_status',
    'Plan task status by type',
    ['status', 'assignee']
)

AGENT_COLLABORATION_COUNT = Counter(
    'agent_collaboration_total',
    'Total agent collaboration requests',
    ['requester', 'target']
)
```

### 日志配置接口
```python
# 结构化日志配置
def setup_logging():
    logger.remove()

    # 添加AutoGen专用日志格式
    logger.add(
        "logs/agents.log",
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {extra[agent_type]} | {extra[task_id]} | {message}",
        rotation="50 MB",
        retention="7 days",
        filter=lambda record: "agent_type" in record["extra"]
    )

    # SOP工作流日志
    logger.add(
        "logs/workflows.log",
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {extra[workflow_id]} | {extra[step_id]} | {message}",
        rotation="20 MB",
        retention="14 days",
        filter=lambda record: "workflow_id" in record["extra"]
    )
```

### 开发注意事项
- 支持AutoGen多智能体协作的专用日志格式
- 实时监控SOP工作流执行状态
- Agent性能指标收集和分析
- 多级告警机制支持不同严重级别
- 日志轮转策略适配Agent高频率日志

### 性能要求
- Agent分析时间监控: ≤30秒告警阈值
- 系统响应时间监控: P95 < 3秒
- 工作流完成率监控: > 95%
- 告警响应时间: < 1分钟

### 监控重点
- **Agent状态监控**: 实时监控S-A-F-E-R智能体状态
- **工作流监控**: SOP工作流执行进度和性能
- **协作监控**: Agent间协作请求和响应时间
- **资源监控**: CPU、内存、网络使用情况
- **AI模型监控**: DeepSeek V3响应时间和准确率

### 告警策略
- **Critical**: Agent崩溃、工作流失败、系统不可用
- **Warning**: Agent响应慢、资源使用高、协作超时
- **Info**: 工作流完成、Agent状态变化

### 测试策略
- 单元测试: 日志格式和输出验证
- 集成测试: 健康检查端点功能
- 性能测试: 监控指标准确性验证
- 告警测试: 多渠道告警发送测试

### 依赖关系
- 依赖Epic 1基础框架
- 集成AutoGen多智能体框架
- 支持Vue3前端监控面板
- 为系统运维提供完整监控能力

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)