# Story 4.1: 主控制台界面开发

## Status
Draft

## Story

**As a** 现场指挥官,
**I want** 一个直观的主控制台界面,
**so that** 能够快速了解系统状态、监控关键指标、并访问核心功能。

## Acceptance Criteria

1. 主控制台能够展示系统整体状态和当前事件信息
2. 实时显示核心指标监控面板（水位、流量、救援进度、人员安全）
3. 提供Agent状态监控和快速导航功能
4. 支持紧急状态预警和通知系统
5. 实现响应式设计，适配不同屏幕尺寸

## Tasks / Subtasks

- [ ] 实现主控制台布局框架 (AC: #1)
  - [ ] 设计响应式布局系统
    - [ ] CSS Grid布局结构
    - [ ] 弹性盒子布局
    - [ ] 媒体查询适配
    - [ ] 断点设计管理
  - [ ] 创建顶部导航栏
    - [ ] 系统标题显示
    - [ ] 用户信息展示
    - [ ] 紧急状态指示器
    - [ ] 快速操作按钮
  - [ ] 实现侧边导航菜单
    - [ ] 功能模块导航
    - [ ] 折叠展开功能
    - [ ] 面包屑导航
    - [ ] 搜索功能
  - [ ] 创建主内容区域
    - [ ] 内容区域布局
    - [ ] 标签页管理
    - [ ] 内容滚动控制
    - [ ] 全屏切换功能
  - [ ] 设计底部状态栏
    - [ ] 系统状态信息
    - [ ] 连接状态指示
    - [ ] 版本信息显示
    - [ ] 快捷键提示

- [ ] 实现核心指标监控面板 (AC: #2)
  - [ ] 设计指标卡片组件
    - [ ] 指标数值显示
    - [ ] 趋势指示器
    - [ ] 单位和标签
    - [ ] 警戒线标识
  - [ ] 实现水位监测组件
    - [ ] 实时水位数据
    - [ ] 历史趋势图表
    - [ ] 警戒值设定
    - [ ] 变化率计算
  - [ ] 创建流量监测组件
    - [ ] 流量数据展示
    - [ ] 峰值标识
    - [ ] 预测值显示
    - [ ] 对比分析
  - [ ] 实现救援进度组件
    - [ ] 进度百分比显示
    - [ ] 任务完成状态
    - [ ] 时间轴展示
    - [ ] 里程碑标记
  - [ ] 创建人员安全组件
    - [ ] 安全状态指示
    - [ ] 人员统计信息
    - [ ] 失联人员提醒
    - [ ] 撤离进度显示

- [ ] 实现Agent状态监控 (AC: #3)
  - [ ] 设计Agent状态卡片
    - [ ] Agent类型标识
    - [ ] 运行状态指示
    - [ ] 置信度显示
    - [ ] 最后更新时间
  - [ ] 实现状态网格布局
    - [ ] 四Agent状态展示
    - [ ] 状态颜色编码
    - [ ] 动画过渡效果
    - [ ] 选中状态管理
  - [ ] 创建性能指标显示
    - [ ] 处理时间统计
    - [ ] 数据量统计
    - [ ] 错误率显示
    - [ ] 资源占用率
  - [ ] 实现Agent快速操作
    - [ ] 重启功能
    - [ ] 配置调整
    - [ ] 日志查看
    - [ ] 详情链接
  - [ ] 设计Agent协作可视化
    - [ ] 协作流程图
    - [ ] 数据流向指示
    - [ ] 状态同步显示
    - [ ] 异常状态提醒

- [ ] 实现事件信息展示 (AC: #4)
  - [ ] 设计事件概览组件
    - [ ] 事件标题显示
    - [ ] 事件类型标识
    - [ ] 严重程度指示
    - [ ] 持续时间统计
  - [ ] 实现影响区域信息
    - [ ] 地理位置显示
    - [ ] 影响范围统计
    - [ ] 人口影响数据
    - [ ] 基础设施状态
  - [ ] 创建救援资源统计
    - [ ] 救援队伍数量
    - [ ] 装备物资统计
    - [ ] 资源调配状态
    - [ ] 资源缺口提示
  - [ ] 实现事件时间线
    - [ ] 关键时间节点
    - [ ] 事件进展记录
    - [ ] 预测里程碑
    - [ ] 历史对比
  - [ ] 设计快速操作面板
    - [ ] 常用功能快捷入口
    - [ ] 紧急操作按钮
    - [ ] 场景切换功能
    - [ ] 设置调整入口

- [ ] 实现实时数据更新和预警 (AC: #5)
  - [ ] 设计数据更新机制
    - [ ] WebSocket连接管理
    - [ ] 数据订阅机制
    - [ ] 更新频率控制
    - [ ] 错误重连机制
  - [ ] 实现实时数据同步
    - [ ] 数据状态管理
    - [ ] 增量更新处理
    - [ ] 数据冲突解决
    - [ ] 本地缓存策略
  - [ ] 创建预警系统
    - [ ] 预警规则配置
    - [ ] 预警级别管理
    - [ ] 预警通知方式
    - [ ] 预警历史记录
  - [ ] 实现通知组件
    - [ ] 通知消息展示
    - [ ] 通知类型分类
    - [ ] 通知优先级排序
    - [ ] 通知操作处理
  - [ ] 设计系统健康监控
    - [ ] 系统状态检查
    - [ ] 性能指标监控
    - [ ] 异常状态检测
    - [ ] 自动恢复机制

## Dev Notes

### 技术架构信息
主控制台界面采用以下技术栈：
- 前端框架: React 18 + TypeScript
- UI组件库: Ant Design 5
- 状态管理: Redux Toolkit + RTK Query
- 数据可视化: ECharts + D3.js
- 实时通信: Socket.IO Client
- 样式方案: CSS Modules + Styled Components

### 主控制台核心设计
```typescript
import React, { useState, useEffect, useCallback } from 'react';
import { Card, Row, Col, Statistic, Alert, Badge, Button, Tooltip } from 'antd';
import { useWebSocket } from '../hooks/useWebSocket';
import { useAppSelector, useAppDispatch } from '../hooks/redux';
import { updateSystemStatus, updateAgentStatus } from '../store/slices/dashboardSlice';
import { AgentStatusCard } from '../components/AgentStatusCard';
import { MetricCard } from '../components/MetricCard';
import { EventOverview } from '../components/EventOverview';
import { NotificationCenter } from '../components/NotificationCenter';

interface DashboardProps {
  eventId: string;
}

interface SystemStatus {
  overall: 'normal' | 'warning' | 'error';
  agents: AgentStatus[];
  lastUpdate: Date;
  activeConnections: number;
}

interface AgentStatus {
  id: string;
  type: 's' | 'a' | 'f' | 'e';
  name: string;
  status: 'running' | 'stopped' | 'error' | 'idle';
  confidence: number;
  lastAnalysis: Date;
  processingTime: number;
  errorCount: number;
}

interface RealTimeMetrics {
  waterLevel: {
    current: number;
    trend: 'up' | 'down' | 'stable';
    changeRate: number;
    warning: number;
  };
  flowRate: {
    current: number;
    peak: number;
    predicted: number;
    unit: string;
  };
  rescueProgress: {
    completed: number;
    total: number;
    percentage: number;
    milestones: Milestone[];
  };
  personnelSafety: {
    safe: number;
    atRisk: number;
    missing: number;
    safetyRate: number;
  };
}

const Dashboard: React.FC<DashboardProps> = ({ eventId }) => {
  const dispatch = useAppDispatch();
  const { systemStatus, currentEvent, realTimeMetrics, notifications } = useAppSelector(state => state.dashboard);

  // WebSocket连接
  const { data: wsData, isConnected } = useWebSocket(`/dashboard/${eventId}`);

  // 本地状态
  const [selectedAgent, setSelectedAgent] = useState<string | null>(null);
  const [alertVisible, setAlertVisible] = useState(true);

  // 处理WebSocket数据更新
  useEffect(() => {
    if (wsData) {
      switch (wsData.type) {
        case 'system_status':
          dispatch(updateSystemStatus(wsData.payload));
          break;
        case 'agent_status':
          dispatch(updateAgentStatus(wsData.payload));
          break;
        case 'metrics_update':
          // 处理指标更新
          break;
        case 'alert':
          // 处理预警信息
          break;
      }
    }
  }, [wsData, dispatch]);

  // 处理Agent选择
  const handleAgentSelect = useCallback((agentId: string) => {
    setSelectedAgent(agentId === selectedAgent ? null : agentId);
  }, [selectedAgent]);

  // 获取系统状态颜色
  const getSystemStatusColor = (status: string) => {
    switch (status) {
      case 'normal': return '#52c41a';
      case 'warning': return '#faad14';
      case 'error': return '#f5222d';
      default: return '#d9d9d9';
    }
  };

  return (
    <div className="dashboard">
      {/* 顶部导航栏 */}
      <header className="dashboard-header">
        <div className="header-content">
          <div className="title-section">
            <h1>SAFE应急决策指挥系统</h1>
            <h2>{currentEvent?.name}</h2>
          </div>

          <div className="status-section">
            <Badge
              status={systemStatus?.overall === 'normal' ? 'success' :
                     systemStatus?.overall === 'warning' ? 'warning' : 'error'}
              text={`系统状态: ${systemStatus?.overall.toUpperCase()}`}
            />
            <span className="connection-status">
              连接状态: {isConnected ? '已连接' : '断开'}
            </span>
          </div>

          <div className="user-section">
            <Button type="primary">紧急预案</Button>
            <Button>系统设置</Button>
            <div className="user-info">
              <span>指挥官</span>
            </div>
          </div>
        </div>
      </header>

      {/* 主要内容区域 */}
      <main className="dashboard-main">
        {/* 事件概览 */}
        <section className="event-overview-section">
          <EventOverview
            event={currentEvent}
            onEventEdit={() => {}}
          />
        </section>

        {/* 核心指标面板 */}
        <section className="metrics-section">
          <Row gutter={[16, 16]}>
            <Col xs={24} sm={12} lg={6}>
              <MetricCard
                title="水位变化"
                value={realTimeMetrics.waterLevel.current}
                unit="m"
                trend={realTimeMetrics.waterLevel.trend}
                changeRate={realTimeMetrics.waterLevel.changeRate}
                warning={realTimeMetrics.waterLevel.warning}
                status={realTimeMetrics.waterLevel.current > realTimeMetrics.waterLevel.warning ? 'warning' : 'normal'}
              />
            </Col>

            <Col xs={24} sm={12} lg={6}>
              <MetricCard
                title="流量监测"
                value={realTimeMetrics.flowRate.current}
                unit={realTimeMetrics.flowRate.unit}
                peak={realTimeMetrics.flowRate.peak}
                predicted={realTimeMetrics.flowRate.predicted}
                status="normal"
              />
            </Col>

            <Col xs={24} sm={12} lg={6}>
              <MetricCard
                title="救援进度"
                value={realTimeMetrics.rescueProgress.percentage}
                unit="%"
                progress={realTimeMetrics.rescueProgress}
                status="normal"
              />
            </Col>

            <Col xs={24} sm={12} lg={6}>
              <MetricCard
                title="人员安全"
                value={realTimeMetrics.personnelSafety.safetyRate}
                unit="%"
                details={{
                  safe: realTimeMetrics.personnelSafety.safe,
                  atRisk: realTimeMetrics.personnelSafety.atRisk,
                  missing: realTimeMetrics.personnelSafety.missing
                }}
                status={realTimeMetrics.personnelSafety.missing > 0 ? 'warning' : 'normal'}
              />
            </Col>
          </Row>
        </section>

        {/* Agent状态监控 */}
        <section className="agent-status-section">
          <h3>Agent状态监控</h3>
          <Row gutter={[16, 16]}>
            {systemStatus?.agents.map((agent) => (
              <Col xs={24} sm={12} lg={6} key={agent.id}>
                <AgentStatusCard
                  agent={agent}
                  selected={selectedAgent === agent.id}
                  onSelect={() => handleAgentSelect(agent.id)}
                />
              </Col>
            ))}
          </Row>
        </section>

        {/* 通知中心 */}
        {notifications.length > 0 && (
          <section className="notification-section">
            <NotificationCenter
              notifications={notifications}
              onDismiss={(id) => {/* 处理通知消失 */}}
              onAction={(id, action) => {/* 处理通知操作 */}}
            />
          </section>
        )}
      </main>

      {/* 底部状态栏 */}
      <footer className="dashboard-footer">
        <div className="footer-content">
          <span>最后更新: {systemStatus?.lastUpdate.toLocaleString()}</span>
          <span>活跃连接: {systemStatus?.activeConnections}</span>
          <span>系统版本: v2.1.0</span>
        </div>
      </footer>
    </div>
  );
};

export default Dashboard;
```

### 开发工作流程
1. 设计响应式布局框架和导航系统
2. 实现核心指标监控面板组件
3. 开发Agent状态监控和可视化
4. 创建事件信息展示和快速操作
5. 实现WebSocket实时数据更新
6. 建立预警系统和通知机制
7. 优化性能和用户体验
8. 进行跨设备兼容性测试

### 依赖关系说明
- 依赖Story 3.1-3.7的后端API服务
- 需要WebSocket实时数据推送服务
- 依赖Ant Design组件库和图表库
- 为其他界面组件提供基础框架

### 重要注意事项
- 界面需要支持实时数据更新和状态同步
- 指标展示需要考虑数据可视化的直观性
- Agent状态需要准确的运行状态反映
- 预警系统需要及时准确的通知机制
- 响应式设计需要适配各种设备屏幕

### 测试策略
- 单元测试: 测试各组件的功能正确性
- 集成测试: 测试数据流和状态管理
- 端到端测试: 测试完整的用户交互流程
- 性能测试: 测试实时数据更新的性能
- 可用性测试: 验证用户体验和易用性

### Testing

#### 测试标准
- 测试文件位置: tests/dashboard/目录
- 布局测试: 验证响应式布局的正确性
- 指标展示测试: 验证数据显示的准确性
- 实时更新测试: 验证WebSocket数据同步
- Agent状态测试: 验证Agent状态监控功能

#### 测试框架和模式
- 单元测试: Jest + React Testing Library
- 集成测试: Cypress + Mock Service Worker
- 端到端测试: Playwright
- 视觉回归测试: Chromatic + Storybook

#### 特定测试要求
- 实时数据更新的稳定性测试
- 大数据量渲染的性能测试
- 长时间运行的稳定性测试
- 多设备适配的兼容性测试
- 网络异常情况的处理测试

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | 初始故事创建 | John (PM) |

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

## QA Results
(待QA测试时填写)