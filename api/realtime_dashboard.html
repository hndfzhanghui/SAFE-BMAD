<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3DA2 å®æ—¶ç›‘æ§ä»ªè¡¨æ¿ - Story 1.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // å¤‡ç”¨CDN
    if (typeof Chart === 'undefined') {
        document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"><\/script>');
    }
  </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; }
        .header { background: rgba(255, 255, 255, 0.95); padding: 1.5rem; text-align: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .header h1 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { color: #7f8c8d; font-size: 1.2rem; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .metric-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0; }
        .metric-label { color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .metric-change { font-size: 0.8rem; margin-top: 0.5rem; }
        .metric-up { color: #27ae60; }
        .metric-down { color: #e74c3c; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
        .chart-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .chart-card h3 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.3rem; }
        .chart-container { position: relative; height: 300px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-healthy { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .alerts-section { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .alert-item { background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #3498db; }
        .alert-critical { border-left-color: #e74c3c; }
        .alert-warning { border-left-color: #f39c12; }
        .alert-info { border-left-color: #3498db; }
        .refresh-btn { background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin: 1rem; }
        .refresh-btn:hover { background: #2980b9; }
        .loading { display: none; text-align: center; padding: 2rem; color: #666; }
        .cpu-high { color: #e74c3c; }
        .cpu-medium { color: #f39c12; }
        .cpu-normal { color: #27ae60; }
        .progress-bar { background: #ecf0f1; border-radius: 10px; height: 8px; margin: 0.5rem 0; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.3s ease; }
        .progress-normal { background: #27ae60; }
        .progress-warning { background: #f39c12; }
        .progress-critical { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ S3DA2 å®æ—¶ç›‘æ§ä»ªè¡¨æ¿</h1>
        <p>Story 1.4 - åŸºç¡€æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ</p>
        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <span id="connection-status" class="status-indicator status-healthy"></span>
        <span id="status-text">è¿æ¥æ­£å¸¸</span>
    </div>

    <div class="container">
        <!-- å®æ—¶ç³»ç»ŸæŒ‡æ ‡ -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">CPU ä½¿ç”¨ç‡</div>
                <div id="cpu-value" class="metric-value">--%</div>
                <div class="progress-bar">
                    <div id="cpu-progress" class="progress-fill progress-normal" style="width: 0%"></div>
                </div>
                <div id="cpu-change" class="metric-change">åŠ è½½ä¸­...</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">å†…å­˜ä½¿ç”¨ç‡</div>
                <div id="memory-value" class="metric-value">--%</div>
                <div class="progress-bar">
                    <div id="memory-progress" class="progress-fill progress-normal" style="width: 0%"></div>
                </div>
                <div id="memory-change" class="metric-change">åŠ è½½ä¸­...</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">ç£ç›˜ä½¿ç”¨ç‡</div>
                <div id="disk-value" class="metric-value">--%</div>
                <div class="progress-bar">
                    <div id="disk-progress" class="progress-fill progress-normal" style="width: 0%"></div>
                </div>
                <div id="disk-change" class="metric-change">åŠ è½½ä¸­...</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">æ´»è·ƒå‘Šè­¦</div>
                <div id="alerts-value" class="metric-value">--</div>
                <div id="alerts-change" class="metric-change">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>ğŸ“ˆ ç³»ç»Ÿæ€§èƒ½è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>ğŸ“Š èµ„æºä½¿ç”¨åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <canvas id="resource-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- å‘Šè­¦åŒºåŸŸ -->
        <div class="alerts-section">
            <h3>ğŸš¨ æœ€æ–°å‘Šè­¦</h3>
            <div id="alerts-container">
                <div class="loading">æ­£åœ¨åŠ è½½å‘Šè­¦ä¿¡æ¯...</div>
            </div>
        </div>
    </div>

    <script>
        let performanceChart, resourceChart;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            try {
                // æ£€æŸ¥Chartæ˜¯å¦åŠ è½½
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded');
                    document.getElementById('performance-chart').parentElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                    document.getElementById('resource-chart').parentElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                    return;
                }

                // æ€§èƒ½è¶‹åŠ¿å›¾
                const perfCtx = document.getElementById('performance-chart').getContext('2d');
                performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU %',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory %',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Disk %',
                            data: [],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            // èµ„æºåˆ†å¸ƒå›¾
            const resCtx = document.getElementById('resource-chart').getContext('2d');
            resourceChart = new Chart(resCtx, {
                type: 'doughnut',
                data: {
                    labels: ['CPUä½¿ç”¨', 'CPUç©ºé—²', 'å†…å­˜ä½¿ç”¨', 'å†…å­˜ç©ºé—²'],
                    datasets: [{
                        data: [0, 100, 0, 100],
                        backgroundColor: [
                            '#e74c3c',
                            'rgba(231, 76, 60, 0.3)',
                            '#3498db',
                            'rgba(52, 152, 219, 0.3)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Failed to initialize charts:', error);
                document.getElementById('performance-chart').parentElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</div>';
                document.getElementById('resource-chart').parentElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetrics(data) {
            try {
                if (!data || !data.system) {
                    console.error('Invalid data received:', data);
                    return;
                }

                // CPU
                const cpuUsage = data.system.cpu.usage;
                const cpuElement = document.getElementById('cpu-value');
                const cpuProgress = document.getElementById('cpu-progress');
                if (cpuElement) {
                    cpuElement.textContent = cpuUsage + '%';
                    cpuElement.className = 'metric-value ' + getCpuClass(cpuUsage);
                }
                if (cpuProgress) {
                    cpuProgress.style.width = cpuUsage + '%';
                    cpuProgress.className = 'progress-fill ' + getProgressClass(cpuUsage);
                }

                // Memory
                const memUsage = data.system.memory.usage;
                const memElement = document.getElementById('memory-value');
                const memProgress = document.getElementById('memory-progress');
                if (memElement) {
                    memElement.textContent = memUsage + '%';
                }
                if (memProgress) {
                    memProgress.style.width = memUsage + '%';
                    memProgress.className = 'progress-fill ' + getProgressClass(memUsage);
                }

                // Disk
                const diskUsage = data.system.disk.usage;
                const diskElement = document.getElementById('disk-value');
                const diskProgress = document.getElementById('disk-progress');
                if (diskElement) {
                    diskElement.textContent = diskUsage + '%';
                }
                if (diskProgress) {
                    diskProgress.style.width = diskUsage + '%';
                    diskProgress.className = 'progress-fill ' + getProgressClass(diskUsage);
                }

                // Alerts
                const alertsElement = document.getElementById('alerts-value');
                if (alertsElement && data.alerts) {
                    alertsElement.textContent = data.alerts.active;
                }

                // æ›´æ–°æ—¶é—´æˆ³
                const now = new Date();
                const cpuChange = document.getElementById('cpu-change');
                const memChange = document.getElementById('memory-change');
                const diskChange = document.getElementById('disk-change');
                const alertsChange = document.getElementById('alerts-change');

                if (cpuChange) cpuChange.textContent = 'æ›´æ–°äº ' + now.toLocaleTimeString();
                if (memChange) memChange.textContent = 'æ›´æ–°äº ' + now.toLocaleTimeString();
                if (diskChange) diskChange.textContent = 'æ›´æ–°äº ' + now.toLocaleTimeString();
                if (alertsChange) alertsChange.textContent = 'æ´»è·ƒå‘Šè­¦æ•°é‡';

            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        function getCpuClass(value) {
            if (value > 80) return 'cpu-high';
            if (value > 60) return 'cpu-medium';
            return 'cpu-normal';
        }

        function getProgressClass(value) {
            if (value > 80) return 'progress-critical';
            if (value > 60) return 'progress-warning';
            return 'progress-normal';
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            try {
                if (!performanceChart || !resourceChart) {
                    console.warn('Charts not initialized, skipping update');
                    return;
                }

                const now = new Date().toLocaleTimeString();

                // æ›´æ–°æ€§èƒ½è¶‹åŠ¿å›¾
                if (performanceChart.data.labels.length > 20) {
                    performanceChart.data.labels.shift();
                    performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
                }

                performanceChart.data.labels.push(now);
                performanceChart.data.datasets[0].data.push(data.system.cpu.usage);
                performanceChart.data.datasets[1].data.push(data.system.memory.usage);
                performanceChart.data.datasets[2].data.push(data.system.disk.usage);
                performanceChart.update();

                // æ›´æ–°èµ„æºåˆ†å¸ƒå›¾
                resourceChart.data.datasets[0].data = [
                    data.system.cpu.usage,
                    100 - data.system.cpu.usage,
                    data.system.memory.usage,
                    100 - data.system.memory.usage
                ];
                resourceChart.update();
            } catch (error) {
                console.error('Failed to update charts:', error);
            }
        }

        // æ›´æ–°å‘Šè­¦
        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            if (alerts.alerts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #27ae60; padding: 2rem;">âœ… å½“å‰æ— æ´»è·ƒå‘Šè­¦</div>';
                return;
            }

            container.innerHTML = alerts.alerts.map(alert => `
                <div class="alert-item alert-${alert.severity}">
                    <strong>${alert.type}</strong>
                    <span style="float: right; color: #666; font-size: 0.9rem;">
                        ${new Date(alert.timestamp).toLocaleString()}
                    </span>
                    <div style="margin-top: 0.5rem;">${alert.message}</div>
                    <div style="margin-top: 0.5rem;">
                        <span class="status-indicator status-${alert.resolved ? 'healthy' : 'error'}"></span>
                        ${alert.resolved ? 'å·²è§£å†³' : 'æœªè§£å†³'}
                    </div>
                </div>
            `).join('');
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                // è·å–å®æ—¶æ•°æ®
                const realtimeResponse = await fetch('/api/dashboard/realtime');
                const realtimeData = await realtimeResponse.json();
                updateMetrics(realtimeData);
                updateCharts(realtimeData);

                // è·å–å‘Šè­¦æ•°æ®
                const alertsResponse = await fetch('/api/dashboard/alerts');
                const alertsData = await alertsResponse.json();
                updateAlerts(alertsData);

                // æ›´æ–°è¿æ¥çŠ¶æ€
                document.getElementById('connection-status').className = 'status-indicator status-healthy';
                document.getElementById('status-text').textContent = 'è¿æ¥æ­£å¸¸';

            } catch (error) {
                console.error('æ•°æ®åˆ·æ–°å¤±è´¥:', error);
                document.getElementById('connection-status').className = 'status-indicator status-error';
                document.getElementById('status-text').textContent = 'è¿æ¥å¤±è´¥';

                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const mockData = generateMockData();
                updateMetrics(mockData);
                updateCharts(mockData);
                updateAlerts({alerts: []});
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå¦‚æœAPIä¸å¯ç”¨ï¼‰
        function generateMockData() {
            return {
                system: {
                    cpu: { usage: Math.random() * 100 },
                    memory: { usage: 40 + Math.random() * 40 },
                    disk: { usage: 20 + Math.random() * 30 }
                },
                alerts: {
                    active: Math.floor(Math.random() * 5)
                }
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshData();

            // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(refreshData, 5000);
        });
    </script>
</body>
</html>